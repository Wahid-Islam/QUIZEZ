<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Slide→Quiz Generator (PDF) — Random Sets + Tutor</title>
<!-- Google Fonts -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<!-- pdf.js library -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js"></script>
<script>
  // Point pdf.js to its worker
  if (window['pdfjsLib']) {
    pdfjsLib.GlobalWorkerOptions.workerSrc = "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js";
  }
</script>

<style>
  :root {
    /* Modern Color System */
    --bg-primary: #ffffff;
    --bg-secondary: #f8fafc;
    --bg-tertiary: #f1f5f9;
    --surface: #ffffff;
    --surface-elevated: #ffffff;
    
    /* Text Colors */
    --text-primary: #0f172a;
    --text-secondary: #475569;
    --text-tertiary: #64748b;
    --text-inverse: #ffffff;
    
    /* Border Colors */
    --border-primary: #e2e8f0;
    --border-secondary: #cbd5e1;
    --border-focus: #3b82f6;
    
    /* Brand Colors */
    --brand-primary: #3b82f6;
    --brand-primary-hover: #2563eb;
    --brand-primary-active: #1d4ed8;
    --brand-secondary: #1e293b;
    
    /* Status Colors */
    --success: #059669;
    --success-bg: #ecfdf5;
    --success-border: #a7f3d0;
    --error: #dc2626;
    --error-bg: #fef2f2;
    --error-border: #fecaca;
    --warning: #d97706;
    --warning-bg: #fffbeb;
    
    /* Shadows */
    --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
    --shadow-base: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
    --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
    --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
    
    /* Radius */
    --radius-sm: 6px;
    --radius-base: 8px;
    --radius-md: 12px;
    --radius-lg: 16px;
    --radius-full: 9999px;
    
    /* Spacing Scale */
    --space-1: 4px;
    --space-2: 8px;
    --space-3: 12px;
    --space-4: 16px;
    --space-5: 20px;
    --space-6: 24px;
    --space-8: 32px;
    --space-10: 40px;
    --space-12: 48px;
  }

  /* Typography System */
  body { 
    font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    line-height: 1.6;
    color: var(--text-primary);
    background: var(--bg-secondary);
    margin: 0;
    padding: var(--space-6);
    font-size: 14px;
  }

  h1 { 
    font-size: 32px;
    font-weight: 700;
    line-height: 1.2;
    margin: 0 0 var(--space-2) 0;
    letter-spacing: -0.025em;
  }

  .sub { 
    color: var(--text-secondary);
    font-size: 16px;
    line-height: 1.5;
    margin: 0 0 var(--space-8) 0;
  }

  /* Layout System */
  .layout { 
    display: grid; 
    grid-template-columns: 1fr 400px; 
    gap: var(--space-8);
    max-width: 1400px;
    margin: 0 auto;
  }

  @media (max-width: 1024px) { 
    .layout { 
      grid-template-columns: 1fr;
      gap: var(--space-6);
    } 
    .right { 
      position: static !important; 
      height: auto !important;
    }
  }

  .left { min-width: 0; }

  .right { 
    background: var(--surface);
    border: 1px solid var(--border-primary);
    border-radius: var(--radius-lg);
    padding: var(--space-6);
    height: calc(100vh - 120px);
    position: sticky;
    top: var(--space-6);
    display: flex;
    flex-direction: column;
    box-shadow: var(--shadow-sm);
    overflow: hidden; /* Prevent the entire sidebar from scrolling */
  }

  /* Card System */
  .card { 
    background: var(--surface);
    border: 1px solid var(--border-primary);
    border-radius: var(--radius-md);
    padding: var(--space-6);
    margin: var(--space-4) 0;
    box-shadow: var(--shadow-sm);
    transition: all 0.2s ease;
  }

  .card:hover {
    box-shadow: var(--shadow-base);
    border-color: var(--border-secondary);
  }

  /* Alternating card colors for visual variety */
  .card:nth-child(odd) {
    background: #e0dce7; /* Light lavender-gray */
  }

  .card:nth-child(even) {
    background: #f0e3db; /* Light peach-beige */
  }

  /* Button System */
  button { 
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: var(--space-3) var(--space-5);
    font-size: 14px;
    font-weight: 500;
    border-radius: var(--radius-base);
    border: 1px solid var(--border-primary);
    background: var(--surface);
    color: var(--text-primary);
    cursor: pointer;
    transition: all 0.2s ease;
    white-space: nowrap;
    text-decoration: none;
    min-height: 40px;
  }

  button:hover {
    background: var(--bg-tertiary);
    border-color: var(--border-secondary);
    transform: translateY(-1px);
    box-shadow: var(--shadow-sm);
  }

  button:active {
    transform: translateY(0);
    box-shadow: none;
  }

  button.primary { 
    background: var(--brand-primary);
    border-color: var(--brand-primary);
    color: var(--text-inverse);
    font-weight: 600;
  }

  button.primary:hover {
    background: var(--brand-primary-hover);
    border-color: var(--brand-primary-hover);
    transform: translateY(-1px);
    box-shadow: var(--shadow-md);
  }

  button.primary:active {
    background: var(--brand-primary-active);
    border-color: var(--brand-primary-active);
  }

  /* Animated Star Button (for Generate Quiz button) */
  button.star-button {
    position: relative;
    padding: 12px 35px;
    background: #fec195;
    font-size: 17px;
    font-weight: 500;
    color: #181818;
    border: 3px solid #fec195;
    border-radius: 8px;
    box-shadow: 0 0 0 #fec1958c;
    transition: all 0.3s ease-in-out;
    cursor: pointer;
    overflow: hidden;
  }

  button.star-button:hover {
    background: transparent;
    color: #fec195;
    box-shadow: 0 0 25px #fec1958c;
    transform: none;
  }

  button.star-button:active {
    transform: scale(0.98);
  }

  .star-1 {
    position: absolute;
    top: 20%;
    left: 20%;
    width: 25px;
    height: auto;
    filter: drop-shadow(0 0 0 #fffdef);
    z-index: -5;
    transition: all 1s cubic-bezier(0.05, 0.83, 0.43, 0.96);
  }

  .star-2 {
    position: absolute;
    top: 45%;
    left: 45%;
    width: 15px;
    height: auto;
    filter: drop-shadow(0 0 0 #fffdef);
    z-index: -5;
    transition: all 1s cubic-bezier(0, 0.4, 0, 1.01);
  }

  .star-3 {
    position: absolute;
    top: 40%;
    left: 40%;
    width: 5px;
    height: auto;
    filter: drop-shadow(0 0 0 #fffdef);
    z-index: -5;
    transition: all 1s cubic-bezier(0, 0.4, 0, 1.01);
  }

  .star-4 {
    position: absolute;
    top: 20%;
    left: 40%;
    width: 8px;
    height: auto;
    filter: drop-shadow(0 0 0 #fffdef);
    z-index: -5;
    transition: all 0.8s cubic-bezier(0, 0.4, 0, 1.01);
  }

  .star-5 {
    position: absolute;
    top: 25%;
    left: 45%;
    width: 15px;
    height: auto;
    filter: drop-shadow(0 0 0 #fffdef);
    z-index: -5;
    transition: all 0.6s cubic-bezier(0, 0.4, 0, 1.01);
  }

  .star-6 {
    position: absolute;
    top: 5%;
    left: 50%;
    width: 5px;
    height: auto;
    filter: drop-shadow(0 0 0 #fffdef);
    z-index: -5;
    transition: all 0.8s ease;
  }

  button.star-button:hover .star-1 {
    position: absolute;
    top: -80%;
    left: -30%;
    width: 25px;
    height: auto;
    filter: drop-shadow(0 0 10px #fffdef);
    z-index: 2;
  }

  button.star-button:hover .star-2 {
    position: absolute;
    top: -25%;
    left: 10%;
    width: 15px;
    height: auto;
    filter: drop-shadow(0 0 10px #fffdef);
    z-index: 2;
  }

  button.star-button:hover .star-3 {
    position: absolute;
    top: 55%;
    left: 25%;
    width: 5px;
    height: auto;
    filter: drop-shadow(0 0 10px #fffdef);
    z-index: 2;
  }

  button.star-button:hover .star-4 {
    position: absolute;
    top: 30%;
    left: 80%;
    width: 8px;
    height: auto;
    filter: drop-shadow(0 0 10px #fffdef);
    z-index: 2;
  }

  button.star-button:hover .star-5 {
    position: absolute;
    top: 25%;
    left: 115%;
    width: 15px;
    height: auto;
    filter: drop-shadow(0 0 10px #fffdef);
    z-index: 2;
  }

  button.star-button:hover .star-6 {
    position: absolute;
    top: 5%;
    left: 60%;
    width: 5px;
    height: auto;
    filter: drop-shadow(0 0 10px #fffdef);
    z-index: 2;
  }

  .fil0 {
    fill: #fffdef;
  }

  /* Input System */
  input[type="text"], 
  input[type="number"], 
  input[type="password"],
  input[type="file"] { 
    padding: var(--space-3) var(--space-4);
    border: 1px solid var(--border-primary);
    border-radius: var(--radius-base);
    background: var(--surface);
    color: var(--text-primary);
    font-size: 14px;
    transition: all 0.2s ease;
    min-height: 40px;
    box-sizing: border-box;
  }

  input[type="text"]:focus,
  input[type="number"]:focus,
  input[type="password"]:focus {
    outline: none;
    border-color: var(--border-focus);
    box-shadow: 0 0 0 3px rgb(59 130 246 / 0.1);
  }

  input[type="file"] {
    padding: var(--space-2);
    cursor: pointer;
  }

  /* Layout Components */
  .row { 
    display: flex; 
    gap: var(--space-3); 
    align-items: center; 
    flex-wrap: wrap; 
  }

  .row label {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    font-size: 14px;
    font-weight: 500;
    color: var(--text-secondary);
  }

  /* Quiz Components */
  .qbox { 
    background: var(--surface);
    border: 1px solid var(--border-primary);
    border-radius: var(--radius-md);
    padding: var(--space-6);
    margin: var(--space-5) 0;
    box-shadow: var(--shadow-sm);
    transition: all 0.2s ease;
  }

  .qbox:hover {
    border-color: var(--border-secondary);
    box-shadow: var(--shadow-base);
  }

  .qtitle { 
    font-weight: 600;
    font-size: 16px;
    margin-bottom: var(--space-4);
    color: var(--text-primary);
    line-height: 1.4;
  }

  .opt { 
    margin: var(--space-3) 0;
    display: flex;
    align-items: flex-start;
    gap: var(--space-3);
    padding: var(--space-3);
    border-radius: var(--radius-base);
    transition: all 0.2s ease;
    cursor: pointer;
  }

  .opt:hover {
    background: var(--bg-tertiary);
  }

  .opt input[type="radio"] {
    margin: 0;
    width: 18px;
    height: 18px;
    flex-shrink: 0;
    margin-top: 2px;
  }

  /* Status and Feedback */
  .muted { color: var(--text-tertiary); }
  .correct { color: var(--success); font-weight: 600; }
  .incorrect { color: var(--error); font-weight: 600; }

  /* Chips and Pills */
  .chip { 
    background: var(--bg-tertiary);
    color: var(--text-secondary);
    display: inline-block;
    padding: var(--space-1) var(--space-3);
    border-radius: var(--radius-full);
    font-size: 12px;
    font-weight: 500;
    margin-bottom: var(--space-2);
  }

  .pill { 
    background: var(--brand-primary);
    color: var(--text-inverse);
    padding: var(--space-1) var(--space-3);
    border-radius: var(--radius-full);
    font-size: 12px;
    font-weight: 600;
    display: inline-block;
  }

  /* Controls */
  .controls { 
    position: sticky;
    bottom: 0;
    background: var(--surface);
    padding: var(--space-4) 0;
    border-top: 1px solid var(--border-primary);
    margin-top: var(--space-4);
    border-radius: var(--radius-md);
  }

  .score { 
    font-weight: 700;
    font-size: 18px;
    margin-top: var(--space-3);
    color: var(--text-primary);
  }

  .fb { 
    margin-top: var(--space-3);
    line-height: 1.6;
    color: var(--text-secondary);
  }

  /* Scorecard */
  .scorecard { 
    background: var(--success-bg);
    border: 1px solid var(--success-border);
    border-radius: var(--radius-md);
    padding: var(--space-5);
    margin-top: var(--space-4);
  }

  .kpi { 
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: var(--space-4);
    margin-top: var(--space-3);
  }

  .kpititle { 
    font-size: 12px;
    color: var(--text-tertiary);
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .kpinum { 
    font-size: 20px;
    font-weight: 700;
    color: var(--text-primary);
    margin-top: var(--space-1);
  }

  .setlabel { 
    font-size: 14px;
    color: var(--text-secondary);
    margin: var(--space-2) 0 0 0;
    font-weight: 500;
  }

  /* Chat System */
  .chat-header { 
    font-weight: 700;
    font-size: 16px;
    margin-bottom: var(--space-3);
    color: var(--text-primary);
  }

  .chat-log { 
    flex: 1;
    overflow-y: scroll !important; /* Force scrollbar to always show */
    overflow-x: hidden;
    border: 1px solid var(--border-primary);
    border-radius: var(--radius-base);
    padding: var(--space-3);
    background: var(--bg-tertiary);
    margin: var(--space-3) 0;
    height: 500px; /* Significantly increased height for better visibility */
    word-wrap: break-word;
    scrollbar-width: thin;
    scrollbar-color: var(--border-secondary) var(--bg-tertiary);
  }

  /* Custom scrollbar for webkit browsers */
  .chat-log::-webkit-scrollbar {
    width: 6px;
  }

  .chat-log::-webkit-scrollbar-track {
    background: var(--bg-tertiary);
    border-radius: var(--radius-base);
  }

  .chat-log::-webkit-scrollbar-thumb {
    background: var(--border-secondary);
    border-radius: var(--radius-base);
  }

  .chat-log::-webkit-scrollbar-thumb:hover {
    background: var(--text-tertiary);
  }

  .msg { 
    margin: var(--space-3) 0; 
    display: flex;
    align-items: flex-end;
  }
  
  .msg.me { 
    justify-content: flex-end;
  }

  .msg.bot {
    justify-content: flex-start;
  }

  .msg .bubble { 
    display: inline-block;
    padding: var(--space-3) var(--space-4);
    max-width: 75%;
    word-wrap: break-word;
    line-height: 1.4;
    position: relative;
    font-size: 14px;
  }

  /* User messages (right side, green) */
  .msg.me .bubble { 
    background: #22c55e;
    color: white;
    border-radius: 20px 20px 6px 20px;
    margin-left: var(--space-4);
  }

  /* Bot messages (left side, light gray) */
  .msg.bot .bubble { 
    background: #f1f5f9;
    color: var(--text-primary);
    border-radius: 20px 20px 20px 6px;
    margin-right: var(--space-4);
    border: 1px solid #e2e8f0;
  }

  /* Typing animation */
  .typing-indicator {
    background: #f1f5f9;
    border: 1px solid #e2e8f0;
    border-radius: 20px 20px 20px 6px;
    padding: var(--space-3) var(--space-4);
    display: inline-block;
    margin-right: var(--space-4);
  }

  .typing-dots {
    display: flex;
    align-items: center;
    gap: 4px;
  }

  .typing-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background-color: #94a3b8;
    animation: typing 1.4s infinite ease-in-out;
  }

  .typing-dot:nth-child(1) { animation-delay: 0s; }
  .typing-dot:nth-child(2) { animation-delay: 0.2s; }
  .typing-dot:nth-child(3) { animation-delay: 0.4s; }

  @keyframes typing {
    0%, 60%, 100% {
      transform: translateY(0);
      opacity: 0.4;
    }
    30% {
      transform: translateY(-10px);
      opacity: 1;
    }
  }

  .chat-input { 
    margin-top: var(--space-3);
    display: flex;
    gap: var(--space-2);
  }

  .chat-input input {
    flex: 1;
  }

  /* Utility Classes */
  .tiny { 
    font-size: 12px;
    color: var(--text-tertiary);
    margin: var(--space-2) 0;
    line-height: 1.4;
  }

  .section-title { 
    font-weight: 700;
    font-size: 16px;
    margin-bottom: var(--space-3);
    color: var(--text-primary);
  }

  .hint { 
    font-size: 12px;
    color: var(--text-tertiary);
    margin-top: var(--space-2);
    line-height: 1.4;
  }

  /* Loading and Progress */
  .barwrap { 
    width: 100%;
    background: var(--bg-tertiary);
    border-radius: var(--radius-full);
    border: 1px solid var(--border-primary);
    height: 8px;
    overflow: hidden;
  }

  .bar { 
    height: 100%;
    background: var(--brand-primary);
    width: 0%;
    transition: width 0.3s ease;
  }

  /* Responsive Design */
  @media (max-width: 768px) {
    body { padding: var(--space-4); }
    
    .kpi { 
      grid-template-columns: repeat(2, 1fr);
      gap: var(--space-3);
    }
    
    .row { 
      flex-direction: column;
      align-items: stretch;
    }
    
    .row label {
      justify-content: space-between;
    }
  }

  /* Focus and Accessibility */
  button:focus-visible,
  input:focus-visible {
    outline: 2px solid var(--brand-primary);
    outline-offset: 2px;
  }

  /* New Component Styles */
  
  /* Step Numbers */
  .step-number {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 28px;
    height: 28px;
    background: var(--brand-primary);
    color: var(--text-inverse);
    border-radius: 50%;
    font-size: 14px;
    font-weight: 600;
    margin-right: var(--space-3);
  }

  .section-title {
    display: flex;
    align-items: center;
    font-weight: 700;
    font-size: 16px;
    margin-bottom: var(--space-4);
    color: var(--text-primary);
  }

  /* File Upload Area */
  .file-upload-area {
    padding: var(--space-4);
    border: 2px dashed var(--border-primary);
    border-radius: var(--radius-md);
    text-align: center;
    transition: all 0.2s ease;
  }

  .file-upload-area:hover {
    border-color: var(--brand-primary);
    background: var(--bg-tertiary);
  }

  .file-upload-area input[type="file"] {
    width: 100%;
    padding: var(--space-3);
    border: none;
    background: transparent;
    text-align: center;
  }

  /* Settings Grid */
  .settings-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: var(--space-4);
    margin-bottom: var(--space-5);
  }

  .form-group {
    display: flex;
    flex-direction: column;
    gap: var(--space-2);
  }

  .form-group label {
    font-size: 14px;
    font-weight: 600;
    color: var(--text-primary);
  }

  .input-hint {
    font-size: 12px;
    color: var(--text-tertiary);
    margin-top: var(--space-1);
  }

  /* Toggle Switch Styling */
  .toggle-group {
    margin: var(--space-4) 0;
  }

  .toggle-label {
    display: flex;
    align-items: center;
    gap: var(--space-3);
    cursor: pointer;
    padding: var(--space-3);
    border-radius: var(--radius-base);
    transition: all 0.2s ease;
    font-size: 14px;
    font-weight: 500;
    color: var(--text-primary);
  }

  .toggle-label:hover {
    background: var(--bg-tertiary);
  }

  .toggle-label input[type="checkbox"] {
    position: absolute;
    opacity: 0;
    pointer-events: none;
  }

  /* Toggle Switch Container */
  .toggle-switch {
    position: relative;
    width: 60px;
    height: 32px;
    background: #cbd5e1;
    border-radius: 16px;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
  }

  /* Toggle Switch Slider */
  .toggle-slider {
    position: absolute;
    top: 2px;
    left: 2px;
    width: 28px;
    height: 28px;
    background: white;
    border-radius: 50%;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
  }

  /* ON State */
  .toggle-label input[type="checkbox"]:checked + .toggle-switch {
    background: #10b981;
  }

  .toggle-label input[type="checkbox"]:checked + .toggle-switch .toggle-slider {
    transform: translateX(28px);
  }

  /* ON/OFF Text */
  .toggle-switch::before {
    content: 'OFF';
    position: absolute;
    right: 6px;
    top: 50%;
    transform: translateY(-50%);
    font-size: 10px;
    font-weight: 600;
    color: white;
    opacity: 1;
    transition: opacity 0.2s ease;
  }

  .toggle-label input[type="checkbox"]:checked + .toggle-switch::before {
    content: 'ON';
    left: 8px;
    right: auto;
    opacity: 1;
  }

  /* Focus state */
  .toggle-label input[type="checkbox"]:focus + .toggle-switch {
    outline: 2px solid var(--brand-primary);
    outline-offset: 2px;
  }

  /* Disabled state */
  .toggle-label input[type="checkbox"]:disabled + .toggle-switch {
    opacity: 0.5;
    cursor: not-allowed;
  }

  .toggle-label input[type="checkbox"]:disabled + .toggle-switch .toggle-slider {
    cursor: not-allowed;
  }

  /* Action Row */
  .action-row {
    display: flex;
    gap: var(--space-3);
    align-items: center;
    flex-wrap: wrap;
  }


  .status-message {
    color: var(--text-tertiary);
    font-size: 14px;
    font-style: italic;
    display: flex;
    align-items: center;
    gap: var(--space-2);
  }

  /* Loading animation for status messages */
  .loading-dots {
    display: inline-flex;
    align-items: center;
    gap: 3px;
  }

  .loading-dot {
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background-color: var(--text-tertiary);
    animation: loadingBounce 1.4s infinite ease-in-out;
  }

  .loading-dot:nth-child(1) { animation-delay: 0s; }
  .loading-dot:nth-child(2) { animation-delay: 0.2s; }
  .loading-dot:nth-child(3) { animation-delay: 0.4s; }

  @keyframes loadingBounce {
    0%, 60%, 100% {
      transform: translateY(0);
      opacity: 0.4;
    }
    30% {
      transform: translateY(-6px);
      opacity: 1;
    }
  }

  /* Quiz Section */
  .quiz-section {
    min-height: 400px;
  }

  .quiz-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--space-4);
    padding-bottom: var(--space-3);
    border-bottom: 1px solid var(--border-primary);
  }

  .timer-container {
    display: flex;
    align-items: center;
    gap: var(--space-2);
  }

  .timer {
    font-family: 'Monaco', 'Menlo', monospace;
    font-size: 16px;
    font-weight: 600;
    color: var(--text-secondary);
    background: var(--bg-tertiary);
    padding: var(--space-2) var(--space-3);
    border-radius: var(--radius-base);
  }

  .control-buttons {
    display: flex;
    gap: var(--space-3);
    margin-bottom: var(--space-2);
  }

  /* Tutor Section */
  .tutor-section {
    flex: 1;
    display: flex;
    flex-direction: column;
    margin-bottom: var(--space-4);
    min-height: 0; /* Allow flex container to shrink */
    overflow: hidden;
  }

  .chat-icon {
    margin-right: var(--space-2);
    font-size: 18px;
  }

  .api-setup {
    margin-bottom: var(--space-4);
  }

  .api-label {
    display: block;
    font-size: 14px;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: var(--space-2);
  }

  .api-input-group {
    position: relative;
    display: flex;
    align-items: center;
    gap: var(--space-2);
  }

  .api-input-group input {
    flex: 1;
  }

  .api-clear-btn {
    background: var(--error);
    color: var(--text-inverse);
    border: none;
    padding: var(--space-2) var(--space-3);
    border-radius: var(--radius-base);
    cursor: pointer;
    font-size: 12px;
    min-width: auto;
    height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
    font-weight: 500;
  }

  .api-clear-btn:hover {
    background: #dc2626;
    transform: scale(1.05);
  }

  .api-status {
    position: absolute;
    right: 65px;
    top: 50%;
    transform: translateY(-50%);
    font-size: 14px;
    font-weight: 600;
    padding: var(--space-1) var(--space-2);
    border-radius: var(--radius-base);
    pointer-events: none;
    z-index: 10;
  }

  .api-status.saved {
    background: var(--success-bg);
    color: var(--success);
    border: 1px solid var(--success-border);
  }

  .api-status.empty {
    background: var(--warning-bg);
    color: var(--warning);
    border: 1px solid var(--warning-bg);
  }

  .api-link {
    color: var(--brand-primary);
    text-decoration: none;
    font-weight: 600;
    border-bottom: 1px solid transparent;
    transition: all 0.2s ease;
  }

  .api-link:hover {
    color: var(--brand-primary-hover);
    border-bottom-color: var(--brand-primary-hover);
    text-decoration: none;
  }

  .api-link:focus {
    outline: 2px solid var(--brand-primary);
    outline-offset: 2px;
    border-radius: var(--radius-sm);
  }

  .chat-container {
    flex: 1;
    display: flex;
    flex-direction: column;
    min-height: 0; /* Allow flex container to shrink */
    height: calc(100% - 120px); /* Fixed height calculation */
  }


  /* Enhanced Quiz Question Styling */
  .qbox {
    background: var(--surface);
    border: 1px solid var(--border-primary);
    border-radius: var(--radius-md);
    padding: var(--space-6);
    margin: var(--space-5) 0;
    box-shadow: var(--shadow-sm);
    transition: all 0.2s ease;
    position: relative;
  }

  .qbox::before {
    content: '';
    position: absolute;
    left: 0;
    top: 0;
    bottom: 0;
    width: 4px;
    background: var(--brand-primary);
    border-radius: var(--radius-sm) 0 0 var(--radius-sm);
  }

  .qbox:hover {
    border-color: var(--border-secondary);
    box-shadow: var(--shadow-base);
    transform: translateY(-1px);
  }

  /* Improved Radio Button Styling */
  .opt input[type="radio"] {
    appearance: none;
    width: 20px;
    height: 20px;
    border: 2px solid var(--border-primary);
    border-radius: 50%;
    background: var(--surface);
    position: relative;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .opt input[type="radio"]:checked {
    border-color: var(--brand-primary);
    background: var(--brand-primary);
  }

  .opt input[type="radio"]:checked::after {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 8px;
    height: 8px;
    background: var(--text-inverse);
    border-radius: 50%;
  }

  .opt input[type="radio"]:focus {
    outline: 2px solid var(--brand-primary);
    outline-offset: 2px;
  }

  /* Checkbox Styling for Multiple Answer Questions */
  .opt input[type="checkbox"] {
    appearance: none;
    width: 20px;
    height: 20px;
    border: 2px solid var(--border-primary);
    border-radius: 4px;
    background: var(--surface);
    position: relative;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .opt input[type="checkbox"]:checked {
    border-color: var(--brand-primary);
    background: var(--brand-primary);
  }

  .opt input[type="checkbox"]:checked::after {
    content: '✓';
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    color: var(--text-inverse);
    font-size: 14px;
    font-weight: bold;
  }

  .opt input[type="checkbox"]:focus {
    outline: 2px solid var(--brand-primary);
    outline-offset: 2px;
  }

  /* Enhanced Scorecard */
  .scorecard {
    background: linear-gradient(135deg, var(--success-bg) 0%, #f0fdf4 100%);
    border: 1px solid var(--success-border);
    border-radius: var(--radius-md);
    padding: var(--space-5);
    margin-top: var(--space-4);
    position: relative;
    overflow: hidden;
  }

  .scorecard::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(90deg, var(--success), #10b981);
  }

  /* Mobile Responsive Improvements */
  @media (max-width: 768px) {
    .settings-grid {
      grid-template-columns: 1fr;
    }
    
    .action-row {
      flex-direction: column;
      align-items: stretch;
    }
    
    .control-buttons {
      flex-direction: column;
    }
    
    .export-buttons {
      flex-direction: row;
      gap: var(--space-3);
    }
    
    .quiz-header {
      flex-direction: column;
      gap: var(--space-2);
      align-items: flex-start;
    }
  }

  /* Footer */
  .footer {
    margin-top: var(--space-12);
    padding: var(--space-8) var(--space-6);
    border-top: 1px solid var(--border-primary);
    background: var(--bg-primary);
    text-align: center;
  }

  .footer-content {
    max-width: 1400px;
    margin: 0 auto;
  }

  .copyright {
    color: var(--text-tertiary);
    font-size: 14px;
    margin: 0;
    font-weight: 500;
  }

  @media (max-width: 768px) {
    .footer {
      padding: var(--space-6) var(--space-4);
    }
    
    .copyright {
      font-size: 12px;
    }
  }

  /* Enhanced Feedback Styling */
  .feedback-container {
    overflow-y: auto;
    border: 1px solid var(--border-primary);
    border-radius: var(--radius-md);
    margin-top: var(--space-4);
    scrollbar-width: thin;
    scrollbar-color: var(--border-secondary) var(--bg-tertiary);
  }

  .feedback-container::-webkit-scrollbar {
    width: 8px;
  }

  .feedback-container::-webkit-scrollbar-track {
    background: var(--bg-tertiary);
    border-radius: var(--radius-base);
  }

  .feedback-container::-webkit-scrollbar-thumb {
    background: var(--border-secondary);
    border-radius: var(--radius-base);
  }

  .feedback-header-controls {
    background: var(--bg-secondary);
    padding: var(--space-3) var(--space-4);
    border-bottom: 1px solid var(--border-primary);
    display: flex;
    justify-content: space-between;
    align-items: center;
    position: sticky;
    top: 0;
    z-index: 10;
  }

  .feedback-title {
    font-weight: 600;
    color: var(--text-primary);
    margin: 0;
  }

  .feedback-toggle {
    background: var(--brand-primary);
    color: var(--text-inverse);
    border: none;
    padding: var(--space-1) var(--space-3);
    border-radius: var(--radius-base);
    font-size: 12px;
    cursor: pointer;
    font-weight: 500;
  }

  .feedback-toggle:hover {
    background: var(--brand-primary-hover);
  }

  .feedback-item {
    background: var(--surface);
    border-bottom: 1px solid var(--border-primary);
    padding: var(--space-4);
    margin: 0;
  }

  .feedback-item:last-child {
    border-bottom: none;
  }

  .feedback-header {
    margin-bottom: var(--space-3);
  }

  .question-number {
    font-weight: 700;
    color: var(--brand-primary);
    margin-right: var(--space-2);
  }

  .feedback-question {
    font-weight: 600;
    font-size: 16px;
    color: var(--text-primary);
    line-height: 1.4;
  }

  .feedback-answers {
    display: flex;
    flex-direction: column;
    gap: var(--space-2);
    margin: var(--space-3) 0;
    padding: var(--space-3);
    background: var(--bg-tertiary);
    border-radius: var(--radius-base);
  }

  .your-answer, .correct-answer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--space-2) 0;
    font-size: 14px;
  }

  .your-answer {
    color: var(--text-secondary);
    border-bottom: 1px solid var(--border-primary);
  }

  .correct-answer {
    color: var(--text-primary);
    font-weight: 500;
  }

  .result-status {
    margin-top: var(--space-2);
    padding: var(--space-2);
    border-radius: var(--radius-base);
    text-align: center;
    font-weight: 600;
  }

  .feedback-explanation {
    background: var(--bg-secondary);
    padding: var(--space-4);
    border-radius: var(--radius-base);
    border-left: 4px solid var(--brand-primary);
    margin-top: var(--space-3);
  }

  .feedback-explanation strong {
    color: var(--brand-primary);
    margin-bottom: var(--space-2);
    display: block;
  }

  /* Mobile responsive feedback */
  @media (max-width: 768px) {
    .feedback-answers {
      gap: var(--space-3);
    }
    
    .your-answer, .correct-answer {
      flex-direction: column;
      align-items: flex-start;
      gap: var(--space-1);
    }
    
    .feedback-item {
      padding: var(--space-4);
    }
  }

  /* Smooth transitions for better UX */
  * {
    transition: background-color 0.2s ease, border-color 0.2s ease, color 0.2s ease;
  }

  /* Progress Button Styling */
  .progress-btn {
    background: linear-gradient(135deg, var(--brand-primary), var(--brand-secondary));
    color: var(--text-inverse);
    border: none;
    padding: var(--space-3) var(--space-5);
    border-radius: var(--radius-base);
    font-weight: 600;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    margin-left: var(--space-3);
  }

  .progress-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    background: linear-gradient(135deg, var(--brand-primary-hover), var(--brand-primary));
  }

  .progress-btn:active {
    transform: translateY(0);
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
  }

  /* No Progress Data Styling */
  .no-progress-content {
    text-align: center;
    padding: var(--space-8);
    max-width: 600px;
    margin: 0 auto;
  }

  .no-progress-icon {
    font-size: 64px;
    margin-bottom: var(--space-4);
  }

  .no-progress-content h3 {
    margin: 0 0 var(--space-3) 0;
    color: var(--text-primary);
    font-size: 24px;
    font-weight: 600;
  }

  .no-progress-content p {
    margin: 0 0 var(--space-6) 0;
    color: var(--text-secondary);
    font-size: 16px;
    line-height: 1.5;
  }

  .progress-features {
    background: var(--bg-secondary);
    border: 1px solid var(--border-primary);
    border-radius: var(--radius-md);
    padding: var(--space-5);
    margin: var(--space-6) 0;
    text-align: left;
  }

  .progress-features h4 {
    margin: 0 0 var(--space-3) 0;
    color: var(--text-primary);
    font-size: 16px;
    font-weight: 600;
  }

  .progress-features ul {
    margin: 0;
    padding-left: var(--space-5);
    color: var(--text-secondary);
    line-height: 1.6;
  }

  .progress-features li {
    margin-bottom: var(--space-2);
  }

  .get-started-btn {
    background: linear-gradient(135deg, var(--success), #10b981);
    color: var(--text-inverse);
    border: none;
    padding: var(--space-4) var(--space-6);
    border-radius: var(--radius-base);
    font-weight: 600;
    font-size: 16px;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
  }

  .get-started-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
    background: linear-gradient(135deg, #10b981, var(--success));
  }

  /* ========== SPECTACULAR ANIMATED LOGO ========== */
  .animated-logo {
    position: relative;
    text-align: center;
    margin: var(--space-6) 0 var(--space-8) 0;
    min-height: 120px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
  }

  .logo-container {
    position: relative;
    display: flex;
    align-items: center;
    gap: var(--space-6);
    z-index: 2;
  }

  /* ===== SLIDE STACK ANIMATION ===== */
  .slide-stack {
    position: relative;
    width: 60px;
    height: 45px;
    margin-right: var(--space-4);
  }

  .slide {
    position: absolute;
    width: 50px;
    height: 35px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 8px;
    box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
    animation: slideFloat 4s ease-in-out infinite;
  }

  .slide-1 {
    top: 0;
    left: 0;
    z-index: 3;
    animation-delay: 0s;
  }

  .slide-2 {
    top: 5px;
    left: 5px;
    z-index: 2;
    animation-delay: 0.5s;
    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    box-shadow: 0 4px 15px rgba(240, 147, 251, 0.3);
  }

  .slide-3 {
    top: 10px;
    left: 10px;
    z-index: 1;
    animation-delay: 1s;
    background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    box-shadow: 0 4px 15px rgba(79, 172, 254, 0.3);
  }

  @keyframes slideFloat {
    0%, 100% { transform: translateY(0) rotate(0deg); }
    25% { transform: translateY(-5px) rotate(1deg); }
    50% { transform: translateY(-8px) rotate(0deg); }
    75% { transform: translateY(-3px) rotate(-1deg); }
  }

  /* ===== ANIMATED ARROW ===== */
  .arrow-container {
    position: relative;
    width: 80px;
    height: 20px;
    margin: 0 var(--space-4);
  }

  .arrow-segment {
    position: absolute;
    height: 4px;
    background: linear-gradient(90deg, var(--brand-primary), var(--brand-secondary));
    border-radius: 2px;
    animation: arrowGlow 2s ease-in-out infinite;
  }

  .arrow-1 {
    width: 30px;
    top: 8px;
    left: 0;
    animation-delay: 0s;
  }

  .arrow-2 {
    width: 25px;
    top: 8px;
    left: 25px;
    animation-delay: 0.3s;
  }

  .arrow-tip {
    position: absolute;
    top: 0;
    right: 0;
    width: 0;
    height: 0;
    border-left: 20px solid var(--brand-primary);
    border-top: 10px solid transparent;
    border-bottom: 10px solid transparent;
    animation: arrowPulse 2s ease-in-out infinite;
  }

  @keyframes arrowGlow {
    0%, 100% { 
      box-shadow: 0 0 5px rgba(59, 130, 246, 0.5);
      transform: scaleX(1);
    }
    50% { 
      box-shadow: 0 0 20px rgba(59, 130, 246, 0.8);
      transform: scaleX(1.1);
    }
  }

  @keyframes arrowPulse {
    0%, 100% { 
      filter: drop-shadow(0 0 5px rgba(59, 130, 246, 0.5));
      transform: translateX(0);
    }
    50% { 
      filter: drop-shadow(0 0 15px rgba(59, 130, 246, 0.8));
      transform: translateX(5px);
    }
  }

  /* ===== QUIZ CIRCLES ANIMATION ===== */
  .quiz-icon {
    position: relative;
    width: 80px;
    height: 80px;
    margin-left: var(--space-4);
  }

  .quiz-circle {
    position: absolute;
    width: 25px;
    height: 25px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: 12px;
    color: white;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    animation: quizOrbit 8s linear infinite;
  }

  .quiz-a {
    background: linear-gradient(135deg, #ff6b6b, #ee5a52);
    animation-delay: 0s;
  }

  .quiz-b {
    background: linear-gradient(135deg, #4ecdc4, #44a08d);
    animation-delay: 2s;
  }

  .quiz-c {
    background: linear-gradient(135deg, #45b7d1, #096bde);
    animation-delay: 4s;
  }

  .quiz-d {
    background: linear-gradient(135deg, #f9ca24, #f0932b);
    animation-delay: 6s;
  }

  @keyframes quizOrbit {
    0% { 
      transform: rotate(0deg) translateX(30px) rotate(0deg) scale(1);
    }
    25% { 
      transform: rotate(90deg) translateX(30px) rotate(-90deg) scale(1.2);
    }
    50% { 
      transform: rotate(180deg) translateX(30px) rotate(-180deg) scale(1);
    }
    75% { 
      transform: rotate(270deg) translateX(30px) rotate(-270deg) scale(1.2);
    }
    100% { 
      transform: rotate(360deg) translateX(30px) rotate(-360deg) scale(1);
    }
  }

  /* ===== ANIMATED TEXT ===== */
  .logo-text {
    display: flex;
    align-items: center;
    gap: var(--space-3);
    font-size: 32px;
    font-weight: 700;
    margin-top: var(--space-4);
  }

  .word-slide {
    background: linear-gradient(135deg, #667eea, #764ba2);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    animation: textGlow 3s ease-in-out infinite;
  }

  .arrow-text {
    font-size: 36px;
    color: var(--brand-primary);
    animation: arrowBounce 2s ease-in-out infinite;
  }

  .word-quiz {
    background: linear-gradient(135deg, #f093fb, #f5576c);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    animation: textGlow 3s ease-in-out infinite 1s;
  }

  .word-generator {
    background: linear-gradient(135deg, #4facfe, #00f2fe);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    animation: textGlow 3s ease-in-out infinite 2s;
    font-size: 24px;
    margin-left: var(--space-2);
  }

  @keyframes textGlow {
    0%, 100% { 
      filter: drop-shadow(0 0 5px rgba(59, 130, 246, 0.3));
      transform: scale(1);
    }
    50% { 
      filter: drop-shadow(0 0 20px rgba(59, 130, 246, 0.6));
      transform: scale(1.05);
    }
  }

  @keyframes arrowBounce {
    0%, 100% { transform: translateX(0) scale(1); }
    50% { transform: translateX(5px) scale(1.1); }
  }

  /* ===== FLOATING PARTICLES ===== */
  .logo-particles {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    overflow: hidden;
  }

  .particle {
    position: absolute;
    width: 6px;
    height: 6px;
    background: radial-gradient(circle, rgba(59, 130, 246, 0.8), rgba(59, 130, 246, 0.2));
    border-radius: 50%;
    animation: particleFloat 6s ease-in-out infinite;
  }

  .particle-1 {
    top: 20%;
    left: 10%;
    animation-delay: 0s;
  }

  .particle-2 {
    top: 40%;
    left: 80%;
    animation-delay: 1s;
  }

  .particle-3 {
    top: 60%;
    left: 20%;
    animation-delay: 2s;
  }

  .particle-4 {
    top: 80%;
    left: 70%;
    animation-delay: 3s;
  }

  .particle-5 {
    top: 30%;
    left: 50%;
    animation-delay: 4s;
  }

  .particle-6 {
    top: 70%;
    left: 40%;
    animation-delay: 5s;
  }

  @keyframes particleFloat {
    0%, 100% { 
      transform: translateY(0) scale(1);
      opacity: 0.7;
    }
    25% { 
      transform: translateY(-20px) scale(1.2);
      opacity: 1;
    }
    50% { 
      transform: translateY(-30px) scale(1);
      opacity: 0.8;
    }
    75% { 
      transform: translateY(-15px) scale(1.1);
      opacity: 0.9;
    }
  }

  /* ===== HOVER INTERACTIONS ===== */
  .animated-logo:hover .slide {
    animation-duration: 2s;
  }

  .animated-logo:hover .quiz-circle {
    animation-duration: 4s;
  }

  .animated-logo:hover .arrow-segment,
  .animated-logo:hover .arrow-tip {
    animation-duration: 1s;
  }

  .animated-logo:hover .particle {
    animation-duration: 3s;
  }

  /* ===== RESPONSIVE DESIGN ===== */
  @media (max-width: 768px) {
    .logo-container {
      flex-direction: column;
      gap: var(--space-4);
    }
    
    .slide-stack,
    .arrow-container,
    .quiz-icon {
      margin: 0;
    }
    
    .logo-text {
      font-size: 24px;
      flex-wrap: wrap;
      justify-content: center;
    }
    
    .word-generator {
      font-size: 18px;
    }
  }

  @media (max-width: 480px) {
    .logo-text {
      font-size: 20px;
    }
    
    .word-generator {
      font-size: 16px;
    }
    
    .slide,
    .quiz-circle {
      transform: scale(0.8);
    }
  }

  /* ========== ELEGANT HERO SUBTITLE ========== */
  .hero-subtitle {
    margin: var(--space-6) auto var(--space-8) auto;
    max-width: 900px;
    text-align: center;
  }

  .subtitle-container {
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05));
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: var(--radius-xl);
    padding: var(--space-6) var(--space-8);
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
  }

  .subtitle-main {
    font-size: 20px;
    font-weight: 500;
    color: var(--text-primary);
    margin-bottom: var(--space-5);
    line-height: 1.4;
  }

  .gemini-highlight {
    background: linear-gradient(135deg, #4285f4, #34a853, #fbbc05, #ea4335);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    font-weight: 600;
    font-size: 22px;
  }

  .subtitle-features {
    display: flex;
    justify-content: center;
    flex-wrap: wrap;
    gap: var(--space-4);
    margin-top: var(--space-4);
  }

  .feature-item {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    padding: var(--space-2) var(--space-4);
    background: rgba(255, 255, 255, 0.08);
    border-radius: var(--radius-full);
    transition: all 0.3s ease;
    border: 1px solid rgba(255, 255, 255, 0.1);
  }

  .feature-item:hover {
    background: rgba(255, 255, 255, 0.15);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
  }

  .feature-icon {
    font-size: 16px;
    opacity: 0.9;
  }

  .feature-text {
    font-size: 14px;
    font-weight: 500;
    color: var(--text-secondary);
    white-space: nowrap;
  }

  /* ===== RESPONSIVE SUBTITLE ===== */
  @media (max-width: 768px) {
    .hero-subtitle {
      margin: var(--space-4) var(--space-3) var(--space-6) var(--space-3);
    }
    
    .subtitle-container {
      padding: var(--space-4) var(--space-5);
    }
    
    .subtitle-main {
      font-size: 18px;
    }
    
    .gemini-highlight {
      font-size: 20px;
    }
    
    .subtitle-features {
      gap: var(--space-2);
    }
    
    .feature-item {
      padding: var(--space-1) var(--space-3);
    }
    
    .feature-text {
      font-size: 13px;
    }
  }

  @media (max-width: 580px) {
    .subtitle-main {
      font-size: 16px;
      margin-bottom: var(--space-3);
    }
    
    .gemini-highlight {
      font-size: 18px;
    }
    
    .subtitle-features {
      flex-direction: column;
      align-items: center;
      gap: var(--space-2);
    }
    
    .feature-item {
      min-width: 200px;
      justify-content: center;
    }
  }

  /* Progress Dashboard Styles */
  .progress-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.7);
    z-index: 1000;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: var(--space-4);
    overflow-y: auto;
  }

  .progress-dashboard {
    background: var(--surface);
    border-radius: var(--radius-lg);
    padding: var(--space-6);
    max-width: 1200px;
    width: 100%;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: var(--shadow-lg);
  }

  .progress-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--space-6);
    padding-bottom: var(--space-4);
    border-bottom: 1px solid var(--border-primary);
  }

  .progress-header h2 {
    margin: 0;
    color: var(--text-primary);
    font-size: 24px;
    font-weight: 700;
  }

  .close-btn {
    background: var(--error);
    color: var(--text-inverse);
    border: none;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    cursor: pointer;
    font-size: 18px;
    font-weight: bold;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .close-btn:hover {
    background: #dc2626;
    transform: scale(1.05);
  }

  .progress-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: var(--space-6);
    margin-bottom: var(--space-6);
  }

  .progress-card {
    background: var(--bg-secondary);
    border: 1px solid var(--border-primary);
    border-radius: var(--radius-md);
    padding: var(--space-5);
  }

  .progress-card h3 {
    margin: 0 0 var(--space-4) 0;
    color: var(--text-primary);
    font-size: 18px;
    font-weight: 600;
  }

  .stat-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: var(--space-4);
  }

  .stat {
    text-align: center;
    padding: var(--space-3);
    background: var(--surface);
    border-radius: var(--radius-base);
    border: 1px solid var(--border-primary);
  }

  .stat-value {
    display: block;
    font-size: 24px;
    font-weight: 700;
    color: var(--brand-primary);
    margin-bottom: var(--space-1);
  }

  .stat-label {
    font-size: 12px;
    color: var(--text-secondary);
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .topic-list, .session-list {
    display: flex;
    flex-direction: column;
    gap: var(--space-3);
  }

  .topic-item, .session-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--space-3);
    background: var(--surface);
    border-radius: var(--radius-base);
    border: 1px solid var(--border-primary);
  }

  .topic-name, .session-topic {
    font-weight: 600;
    color: var(--text-primary);
    flex: 1;
  }

  .topic-stats, .session-item > div:not(.session-topic) {
    display: flex;
    gap: var(--space-2);
    align-items: center;
    font-size: 12px;
  }

  .topic-score, .session-score {
    padding: var(--space-1) var(--space-2);
    border-radius: var(--radius-sm);
    font-weight: 600;
    font-size: 12px;
  }

  .topic-score.good, .session-score.good {
    background: var(--success-bg);
    color: var(--success);
  }

  .topic-score.okay, .session-score.okay {
    background: var(--warning-bg);
    color: var(--warning);
  }

  .topic-score.needs-work, .session-score.needs-work {
    background: var(--error-bg);
    color: var(--error);
  }

  .topic-attempts, .topic-best, .session-date, .session-time {
    color: var(--text-tertiary);
    font-size: 11px;
  }

  .weak-areas {
    display: flex;
    flex-direction: column;
    gap: var(--space-2);
  }

  .weak-area {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--space-2) var(--space-3);
    background: var(--error-bg);
    border: 1px solid var(--error-border);
    border-radius: var(--radius-base);
  }

  .weak-concept {
    font-weight: 600;
    color: var(--error);
  }

  .weak-topic {
    font-size: 12px;
    color: var(--text-secondary);
  }

  .weak-count {
    font-size: 12px;
    color: var(--error);
    font-weight: 600;
  }

  .no-weak-areas {
    text-align: center;
    padding: var(--space-4);
    color: var(--success);
    font-weight: 600;
    background: var(--success-bg);
    border-radius: var(--radius-base);
  }

  .progress-actions {
    display: flex;
    gap: var(--space-3);
    justify-content: center;
    padding-top: var(--space-4);
    border-top: 1px solid var(--border-primary);
  }

  .export-btn, .clear-btn {
    padding: var(--space-3) var(--space-5);
    border-radius: var(--radius-base);
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .export-btn {
    background: var(--brand-primary);
    color: var(--text-inverse);
    border: none;
  }

  .export-btn:hover {
    background: var(--brand-primary-hover);
    transform: translateY(-1px);
  }

  .clear-btn {
    background: var(--surface);
    color: var(--error);
    border: 1px solid var(--error);
  }

  .clear-btn:hover {
    background: var(--error);
    color: var(--text-inverse);
  }

  @media (max-width: 768px) {
    .progress-grid {
      grid-template-columns: 1fr;
    }
    
    .stat-grid {
      grid-template-columns: 1fr;
    }
    
    .progress-actions {
      flex-direction: column;
    }
    
    .topic-item, .session-item {
      flex-direction: column;
      align-items: flex-start;
      gap: var(--space-2);
    }
  }
</style>
</head>
<body>
  <div class="animated-logo">
    <div class="logo-container">
      <div class="logo-icon">
        <div class="slide-stack">
          <div class="slide slide-1"></div>
          <div class="slide slide-2"></div>
          <div class="slide slide-3"></div>
        </div>
        <div class="arrow-container">
          <div class="arrow-segment arrow-1"></div>
          <div class="arrow-segment arrow-2"></div>
          <div class="arrow-tip"></div>
        </div>
        <div class="quiz-icon">
          <div class="quiz-circle quiz-a">A</div>
          <div class="quiz-circle quiz-b">B</div>
          <div class="quiz-circle quiz-c">C</div>
          <div class="quiz-circle quiz-d">D</div>
        </div>
      </div>
      <div class="logo-text">
        <span class="word-slide">Slide</span>
        <span class="arrow-text">→</span>
        <span class="word-quiz">Quiz</span>
        <span class="word-generator">Generator</span>
      </div>
    </div>
    <div class="logo-particles">
      <div class="particle particle-1"></div>
      <div class="particle particle-2"></div>
      <div class="particle particle-3"></div>
      <div class="particle particle-4"></div>
      <div class="particle particle-5"></div>
      <div class="particle particle-6"></div>
    </div>
  </div>
  <div class="hero-subtitle">
    <div class="subtitle-container">
      <div class="subtitle-main">
        Transform your PDF slides into interactive quizzes powered by <span class="gemini-highlight">Gemini AI</span>
      </div>
      <div class="subtitle-features">
        <div class="feature-item">
          <span class="feature-icon">📚</span>
          <span class="feature-text">Upload PDF slides</span>
        </div>
        <div class="feature-item">
          <span class="feature-icon">⚙️</span>
          <span class="feature-text">Customize questions & sets</span>
        </div>
        <div class="feature-item">
          <span class="feature-icon">🤖</span>
          <span class="feature-text">AI-powered generation</span>
        </div>
        <div class="feature-item">
          <span class="feature-icon">🎲</span>
          <span class="feature-text">Smart randomization</span>
        </div>
        <div class="feature-item">
          <span class="feature-icon">💬</span>
          <span class="feature-text">Interactive tutor</span>
        </div>
      </div>
    </div>
  </div>

  <div class="layout">
    <main class="left">
      <section class="card">
        <div class="section-title">
          <span class="step-number">1</span>
          Upload slides (PDF)
        </div>
        <div class="file-upload-area">
          <input id="pdfInput" type="file" accept="application/pdf" multiple aria-describedby="file-hint" />
          <div id="file-hint" class="hint">You can select multiple PDFs. Text is extracted locally in your browser with pdf.js. For image-heavy PDFs, Gemini Vision will automatically extract content from visual elements when needed.</div>
        </div>
      </section>

      <section class="card">
        <div class="section-title">
          <span class="step-number">2</span>
          Settings
        </div>
        <div class="settings-grid">
          <div class="form-group">
            <label for="numSets">Number of sets</label>
            <input id="numSets" type="number" min="1" max="10" value="3" aria-describedby="sets-hint"/>
            <div id="sets-hint" class="input-hint">1-10 different quiz sets</div>
          </div>
          <div class="form-group">
            <label for="perSet">Questions per set</label>
            <input id="perSet" type="number" min="5" max="60" value="30" aria-describedby="questions-hint"/>
            <div id="questions-hint" class="input-hint">5-60 questions each</div>
          </div>
          <div class="form-group">
            <label for="seed">Random seed (optional)</label>
            <input id="seed" type="text" placeholder="e.g. 42" aria-describedby="seed-hint"/>
            <div id="seed-hint" class="input-hint">For reproducible randomness</div>
          </div>
        </div>
        <div class="toggle-group">
          <label class="toggle-label">
            <input id="useLLM" type="checkbox"/>
            <span class="toggle-switch">
              <span class="toggle-slider"></span>
            </span>
            Use Gemini AI to generate questions (Auto-enabled with API key)
          </label>
        </div>
        <div class="action-row" style="justify-content: space-between;">
          <div style="display: flex; align-items: center; gap: var(--space-3);">
            <button class="star-button" onclick="generateQuizzes()" aria-describedby="status">
              <svg class="star-1" viewBox="0 0 784.11 815.53">
                <defs>
                  <style>.fil0{fill:#fffdef}</style>
                </defs>
                <g>
                  <path class="fil0" d="M392.05 0c-20.9,210.08 -184.06,378.41 -392.05,407.78 207.96,29.37 371.12,197.68 392.05,407.75 20.93,-210.07 184.09,-378.38 392.06,-407.75 -207.98,-29.38 -371.14,-197.69 -392.06,-407.78z"/>
                </g>
              </svg>
              <svg class="star-2" viewBox="0 0 784.11 815.53">
                <defs>
                  <style>.fil0{fill:#fffdef}</style>
                </defs>
                <g>
                  <path class="fil0" d="M392.05 0c-20.9,210.08 -184.06,378.41 -392.05,407.78 207.96,29.37 371.12,197.68 392.05,407.75 20.93,-210.07 184.09,-378.38 392.06,-407.75 -207.98,-29.38 -371.14,-197.69 -392.06,-407.78z"/>
                </g>
              </svg>
              <svg class="star-3" viewBox="0 0 784.11 815.53">
                <defs>
                  <style>.fil0{fill:#fffdef}</style>
                </defs>
                <g>
                  <path class="fil0" d="M392.05 0c-20.9,210.08 -184.06,378.41 -392.05,407.78 207.96,29.37 371.12,197.68 392.05,407.75 20.93,-210.07 184.09,-378.38 392.06,-407.75 -207.98,-29.38 -371.14,-197.69 -392.06,-407.78z"/>
                </g>
              </svg>
              <svg class="star-4" viewBox="0 0 784.11 815.53">
                <defs>
                  <style>.fil0{fill:#fffdef}</style>
                </defs>
                <g>
                  <path class="fil0" d="M392.05 0c-20.9,210.08 -184.06,378.41 -392.05,407.78 207.96,29.37 371.12,197.68 392.05,407.75 20.93,-210.07 184.09,-378.38 392.06,-407.75 -207.98,-29.38 -371.14,-197.69 -392.06,-407.78z"/>
                </g>
              </svg>
              <svg class="star-5" viewBox="0 0 784.11 815.53">
                <defs>
                  <style>.fil0{fill:#fffdef}</style>
                </defs>
                <g>
                  <path class="fil0" d="M392.05 0c-20.9,210.08 -184.06,378.41 -392.05,407.78 207.96,29.37 371.12,197.68 392.05,407.75 20.93,-210.07 184.09,-378.38 392.06,-407.75 -207.98,-29.38 -371.14,-197.69 -392.06,-407.78z"/>
                </g>
              </svg>
              <svg class="star-6" viewBox="0 0 784.11 815.53">
                <defs>
                  <style>.fil0{fill:#fffdef}</style>
                </defs>
                <g>
                  <path class="fil0" d="M392.05 0c-20.9,210.08 -184.06,378.41 -392.05,407.78 207.96,29.37 371.12,197.68 392.05,407.75 20.93,-210.07 184.09,-378.38 392.06,-407.75 -207.98,-29.38 -371.14,-197.69 -392.06,-407.78z"/>
                </g>
              </svg>
            Generate quizzes
          </button>
            <div id="status" class="status-message" aria-live="polite"></div>
          </div>
          <button onclick="resetToRandomSet()">
            Reset (random set)
          </button>
          <button onclick="showProgressDashboard()" class="progress-btn">
            📊 Progress
          </button>
        </div>
      </section>

      <section class="card quiz-section">
        <div class="quiz-header">
          <div id="setinfo" class="setlabel"></div>
          <div class="timer-container">
            <span id="timer" class="timer"></span>
          </div>
        </div>
        <div id="quiz" role="form" aria-label="Quiz questions"></div>
        <div class="controls">
          <div class="control-buttons">
            <button class="star-button" onclick="grade()" style="margin-left: 12px; margin-top: 10px;">
              <svg class="star-1" viewBox="0 0 784.11 815.53">
                <defs>
                  <style>.fil0{fill:#fffdef}</style>
                </defs>
                <g>
                  <path class="fil0" d="M392.05 0c-20.9,210.08 -184.06,378.41 -392.05,407.78 207.96,29.37 371.12,197.68 392.05,407.75 20.93,-210.07 184.09,-378.38 392.06,-407.75 -207.98,-29.38 -371.14,-197.69 -392.06,-407.78z"/>
                </g>
              </svg>
              <svg class="star-2" viewBox="0 0 784.11 815.53">
                <defs>
                  <style>.fil0{fill:#fffdef}</style>
                </defs>
                <g>
                  <path class="fil0" d="M392.05 0c-20.9,210.08 -184.06,378.41 -392.05,407.78 207.96,29.37 371.12,197.68 392.05,407.75 20.93,-210.07 184.09,-378.38 392.06,-407.75 -207.98,-29.38 -371.14,-197.69 -392.06,-407.78z"/>
                </g>
              </svg>
              <svg class="star-3" viewBox="0 0 784.11 815.53">
                <defs>
                  <style>.fil0{fill:#fffdef}</style>
                </defs>
                <g>
                  <path class="fil0" d="M392.05 0c-20.9,210.08 -184.06,378.41 -392.05,407.78 207.96,29.37 371.12,197.68 392.05,407.75 20.93,-210.07 184.09,-378.38 392.06,-407.75 -207.98,-29.38 -371.14,-197.69 -392.06,-407.78z"/>
                </g>
              </svg>
              <svg class="star-4" viewBox="0 0 784.11 815.53">
                <defs>
                  <style>.fil0{fill:#fffdef}</style>
                </defs>
                <g>
                  <path class="fil0" d="M392.05 0c-20.9,210.08 -184.06,378.41 -392.05,407.78 207.96,29.37 371.12,197.68 392.05,407.75 20.93,-210.07 184.09,-378.38 392.06,-407.75 -207.98,-29.38 -371.14,-197.69 -392.06,-407.78z"/>
                </g>
              </svg>
              <svg class="star-5" viewBox="0 0 784.11 815.53">
                <defs>
                  <style>.fil0{fill:#fffdef}</style>
                </defs>
                <g>
                  <path class="fil0" d="M392.05 0c-20.9,210.08 -184.06,378.41 -392.05,407.78 207.96,29.37 371.12,197.68 392.05,407.75 20.93,-210.07 184.09,-378.38 392.06,-407.75 -207.98,-29.38 -371.14,-197.69 -392.06,-407.78z"/>
                </g>
              </svg>
              <svg class="star-6" viewBox="0 0 784.11 815.53">
                <defs>
                  <style>.fil0{fill:#fffdef}</style>
                </defs>
                <g>
                  <path class="fil0" d="M392.05 0c-20.9,210.08 -184.06,378.41 -392.05,407.78 207.96,29.37 371.12,197.68 392.05,407.75 20.93,-210.07 184.09,-378.38 392.06,-407.75 -207.98,-29.38 -371.14,-197.69 -392.06,-407.78z"/>
                </g>
              </svg>
              Grade my quiz
            </button>
            <button onclick="resetToRandomSet()" style="margin-top: 12px;">
              New random set
            </button>
          </div>
          <div class="scorecard" id="scorecard" style="display:none;" role="region" aria-label="Quiz results"></div>
          <div class="score" id="score" aria-live="polite"></div>
          <div class="fb" id="feedback" aria-live="polite"></div>
        </div>
      </section>
    </main>

    <aside class="right">
      <section class="tutor-section">
        <div class="chat-header">
          <span class="chat-icon">🤖</span>
          AI Tutor (Gemini)
        </div>
        <div class="api-setup">
          <label for="apikey" class="api-label">API Key (session storage)</label>
          <div class="api-input-group">
            <input type="password" id="apikey" placeholder="Enter your Gemini API key" aria-describedby="api-hint"/>
            <button type="button" class="api-clear-btn" onclick="clearApiKey()" title="Clear API key">
              Clear
            </button>
            <div class="api-status" id="api-status"></div>
          </div>
          <div id="api-hint" class="tiny">
            🔒 <strong>Secure:</strong> Key saved for this browser session only. Automatically cleared when you close the browser.
            <br>💡 Your tutor uses slide content to provide hints and explanations without revealing quiz answers.
            <br>🗝️ <strong>Get API Key:</strong> Visit <a href="https://aistudio.google.com/apikey" target="_blank" class="api-link">Google AI Studio</a> and press "Create API key" then select "Create project" or use existing project.
          </div>
        </div>
        <div class="chat-container">
          <div class="chat-log" id="chatlog" role="log" aria-label="Chat conversation"></div>
          <div class="chat-input">
            <input type="text" id="chattext" placeholder="Ask about concepts from your slides..." aria-label="Chat message"/>
            <button onclick="sendMsg()" aria-label="Send message">
              Send
            </button>
          </div>
        </div>
      </section>
    </aside>
  </div>

  <footer class="footer">
    <div class="footer-content">
      <p class="copyright">© 2025 MD Wahid Islam Arefin. All rights reserved.</p>
    </div>
  </footer>

<script>
// ============ Utilities ============
function $(id){ return document.getElementById(id); }
function randInt(n){ return Math.floor(Math.random()*n); }
function seededRandom(seed){
  let h = 2166136261 >>> 0;
  for (let i=0;i<seed.length;i++){ h ^= seed.charCodeAt(i); h = Math.imul(h, 16777619); }
  return function(){ h += 0x6D2B79F5; let t = Math.imul(h ^ h>>>15, 1 | h); t ^= t + Math.imul(t ^ t>>>7, 61 | t); return ((t ^ t>>>14) >>> 0) / 4294967296; }
}
function shuffle(arr, rng=Math.random){ for (let i=arr.length-1;i>0;i--){ const j = Math.floor(rng()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]]; } return arr; }

// ============ Enhanced PDF content extraction ============
async function extractTextFromFiles(files){
  let fullText = "";
  let hasInsufficientText = false;
  
  for (const file of files){
    const buf = await file.arrayBuffer();
    const pdf = await pdfjsLib.getDocument({data: new Uint8Array(buf)}).promise;
    let fileText = "";
    
    // Extract text content first
    for (let p=1; p<=pdf.numPages; p++){
      const page = await pdf.getPage(p);
      const content = await page.getTextContent();
      const strings = content.items.map(it => it.str);
      const pageText = strings.join(" ");
      fileText += "\n\n# Page "+p+"\n" + pageText;
    }
    
    // Check if text extraction was insufficient
    const meaningfulText = fileText.replace(/\s+/g, ' ').replace(/page \d+/gi, '').trim();
    if (meaningfulText.length < 300) {
      hasInsufficientText = true;
      console.log(`Limited text found in ${file.name} (${meaningfulText.length} chars), will use image analysis if API key available.`);
    }
    
    fullText += "\n\n===== FILE: "+file.name+" =====\n"+fileText;
  }
  
  // If text is insufficient and we have an API key, extract from images
  if (hasInsufficientText) {
    const apiKey = getImageExtractionApiKey();
    if (apiKey) {
      setStatus("📷 Limited text found. Analyzing images with Gemini Vision", true);
      const imageContent = await extractContentFromImages(files, apiKey);
      if (imageContent.trim()) {
        fullText += "\n\n===== EXTRACTED FROM IMAGES =====\n" + imageContent;
        console.log(`Extracted ${imageContent.length} characters from images`);
      }
    } else {
      console.warn("Insufficient text and no API key available for image analysis");
    }
  }
  
  return fullText;
}

function getImageExtractionApiKey() {
  // Use the provided API key specifically for image extraction
  const providedKey = "AIzaSyBZBwHzkD3JrAEVBLwqp0zwxd9ZRQoPjjE";
  
  // Also check if user has their own API key
  const userKey = $("apikey").value.trim();
  
  // Prefer user's key if available, otherwise use provided key for image extraction only
  return userKey || providedKey;
}

async function extractContentFromImages(files, apiKey) {
  let imageContent = "";
  
  try {
    for (const file of files) {
      const buf = await file.arrayBuffer();
      const pdf = await pdfjsLib.getDocument({data: new Uint8Array(buf)}).promise;
      
      // Process a limited number of pages to avoid excessive API calls
      const maxPages = Math.min(pdf.numPages, 10);
      
      for (let p = 1; p <= maxPages; p++) {
        try {
          const page = await pdf.getPage(p);
          
          // Render page to canvas to extract visual content
          const viewport = page.getViewport({ scale: 1.5 });
          const canvas = document.createElement('canvas');
          const context = canvas.getContext('2d');
          canvas.height = viewport.height;
          canvas.width = viewport.width;
          
          const renderContext = {
            canvasContext: context,
            viewport: viewport
          };
          
          await page.render(renderContext).promise;
          
          // Convert canvas to base64 image
          const imageData = canvas.toDataURL('image/jpeg', 0.8);
          const base64Data = imageData.split(',')[1];
          
          // Analyze image with Gemini Vision
          const pageContent = await analyzeImageWithGemini(base64Data, apiKey, file.name, p);
          if (pageContent.trim()) {
            imageContent += `\n\n## ${file.name} - Page ${p} (from image):\n${pageContent}`;
          }
          
          // Small delay to avoid overwhelming the API
          await new Promise(resolve => setTimeout(resolve, 500));
          
        } catch (pageError) {
          console.warn(`Error processing page ${p} of ${file.name}:`, pageError);
        }
      }
    }
  } catch (error) {
    console.error("Error in image content extraction:", error);
  }
  
  return imageContent;
}

async function analyzeImageWithGemini(base64Image, apiKey, fileName, pageNum) {
  try {
    const prompt = `Analyze this slide/document page and extract all readable text, concepts, and educational content. Include:

1. All visible text (headings, bullet points, paragraphs)
2. Key concepts and terms mentioned
3. Any data, numbers, or statistics shown
4. Diagram labels, chart titles, and figure captions
5. Important relationships or processes illustrated
6. **CRITICAL**: Any programming code, regex patterns, or technical syntax
7. **PRESERVE**: Special characters like *, +, ?, ^, $, [], {}, (), |, \\ exactly as shown
8. **TECHNICAL CONTENT**: Function calls, variable names, code snippets, command syntax

SPECIAL ATTENTION FOR TECHNICAL CONTENT:
- If you see regex patterns (*, +, ?, ^, $, \\d, \\w, \\s, [a-z], etc.), preserve them exactly
- If you see programming code or syntax, include it verbatim
- Don't ignore or simplify technical symbols and patterns
- Include any code examples, function definitions, or command syntax

Format the response as clear, educational content that could be used to generate quiz questions. Focus on extractable knowledge rather than visual descriptions.

If this appears to be a slide presentation, extract the main learning objectives and key points, paying special attention to any technical or programming content.`;

    const payload = {
      contents: [{
        role: "user",
        parts: [
          { text: prompt },
          {
            inline_data: {
              mime_type: "image/jpeg",
              data: base64Image
            }
          }
        ]
      }],
      generationConfig: {
        temperature: 0.1, // Low temperature for consistent extraction
        maxOutputTokens: 1000
      }
    };

    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${encodeURIComponent(apiKey)}`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(payload)
    });

    if (!response.ok) {
      const errorText = await response.text();
      console.error(`Gemini Vision API error for ${fileName} page ${pageNum}:`, errorText);
      return "";
    }

    const data = await response.json();
    const content = data?.candidates?.[0]?.content?.parts?.[0]?.text || "";
    
    return content.trim();
    
  } catch (error) {
    console.error(`Error analyzing image for ${fileName} page ${pageNum}:`, error);
    return "";
  }
}

// ============ Enhanced text validation and generic questions ============
function generateGenericQuestions(n) {
  const genericQuestions = [
    {q: "What is a key principle in effective learning?", opts: ["Understanding concepts thoroughly", "Memorizing information quickly", "Avoiding difficult topics", "Copying from others"], ans: 0, exp: "Deep understanding of concepts leads to better retention and application."},
    {q: "Which approach is most effective for academic study?", opts: ["Systematic and methodical", "Random and sporadic", "Passive reading only", "Last-minute cramming"], ans: 0, exp: "Systematic study methods provide better long-term learning outcomes."},
    {q: "What characterizes high-quality academic work?", opts: ["Accuracy and critical thinking", "Length and complexity", "Speed of completion", "Personal opinions only"], ans: 0, exp: "Quality academic work demonstrates accuracy, critical analysis, and clear reasoning."},
    {q: "In problem-solving, what is the most important first step?", opts: ["Understanding the problem clearly", "Jumping to solutions", "Gathering any data", "Making assumptions"], ans: 0, exp: "Clear problem understanding guides all subsequent problem-solving steps."},
    {q: "What makes information reliable and trustworthy?", opts: ["Credible sources and verification", "Popularity and repetition", "Personal preferences", "Complexity of language"], ans: 0, exp: "Reliable information comes from credible sources and can be verified."},
    {q: "Which skill is essential for academic success?", opts: ["Critical thinking and analysis", "Memorization only", "Following instructions blindly", "Avoiding challenging concepts"], ans: 0, exp: "Critical thinking enables students to analyze, evaluate, and synthesize information effectively."},
    {q: "What is the purpose of studying methodology?", opts: ["To approach problems systematically", "To make work more complicated", "To avoid thinking critically", "To speed up completion"], ans: 0, exp: "Methodology provides systematic approaches to learning and problem-solving."},
    {q: "In academic communication, what is most important?", opts: ["Clarity and precision", "Complex vocabulary", "Personal opinions", "Lengthy explanations"], ans: 0, exp: "Clear, precise communication ensures ideas are understood correctly."},
    {q: "What characterizes effective research?", opts: ["Thorough investigation and analysis", "Quick conclusions", "Biased perspectives", "Limited sources"], ans: 0, exp: "Effective research involves comprehensive investigation and objective analysis."},
    {q: "Which approach leads to better understanding?", opts: ["Active engagement with material", "Passive reading", "Avoiding difficult concepts", "Relying on others' interpretations"], ans: 0, exp: "Active engagement promotes deeper understanding and retention."},
    {q: "What is essential for academic integrity?", opts: ["Honesty and proper attribution", "Competition at any cost", "Hiding sources", "Taking shortcuts"], ans: 0, exp: "Academic integrity requires honest work and proper acknowledgment of sources."},
    {q: "In evaluation and assessment, what matters most?", opts: ["Understanding and application", "Memorized facts only", "Speed of response", "Guessing strategies"], ans: 0, exp: "True learning is demonstrated through understanding and ability to apply knowledge."}
  ];
  
  shuffle(genericQuestions, Math.random);
  const selected = [];
  for (let i = 0; i < n && i < genericQuestions.length; i++) {
    selected.push(genericQuestions[i]);
  }
  
  // Fill remaining with educational variations if needed
  while (selected.length < n) {
    const templates = [
      {
        q: `What is a fundamental principle in effective study? (Question ${selected.length + 1})`,
        opts: ["Consistent practice and review", "Cramming before tests", "Avoiding challenging material", "Studying without breaks"],
      ans: 0,
        exp: "Consistent practice and regular review strengthen understanding and retention."
      },
      {
        q: `Which approach promotes better learning outcomes? (Question ${selected.length + 1})`,
        opts: ["Active questioning and exploration", "Passive acceptance of information", "Avoiding difficult concepts", "Rushing through material"],
        ans: 0,
        exp: "Active engagement through questioning leads to deeper understanding."
      },
      {
        q: `What characterizes quality academic analysis? (Question ${selected.length + 1})`,
        opts: ["Evidence-based reasoning", "Personal opinions only", "Unsupported claims", "Emotional arguments"],
        ans: 0,
        exp: "Quality analysis is supported by evidence and logical reasoning."
      }
    ];
    
    const template = templates[(selected.length - genericQuestions.length) % templates.length];
    selected.push(template);
  }
  
  return selected;
}

// ============ Enhanced heuristic fallback question generator ============
function heuristicGenerate(text, n, rng){
  // Check if we have sufficient text content
  if (!text || text.trim().length < 200) {
    console.warn("Insufficient text content, using generic questions");
    return generateGenericQuestions(n);
  }
  
  const questions = [];
  const usedContent = new Set(); // Track used content to avoid duplicates
  
  // Extract key terms and concepts
  const keyTerms = extractKeyTerms(text);
  const sentences = extractGoodSentences(text);
  
  // Check if this is primarily regex content - be much more specific to avoid false positives
  const regexTermCount = (text.match(/regex|regular\s+expression/gi) || []).length;
  const specificRegexTerms = /metacharacter|character\s+class|quantifier.*(?:regex|\+|\*|\?)|\\[dwsWDS]|pythex|regexper|\[\^[^\]]*\]|\{[0-9,]+\}/i.test(text);
  const isRegexDocument = regexTermCount >= 2 || specificRegexTerms;
  
  // If this appears to be regex content, prioritize regex questions
  if (isRegexDocument) {
    console.log("Detected regex content - generating ONLY regex questions");
    
    // Generate ALL regex questions for regex documents
    const maxAttempts = n * 5; // More attempts to ensure we get enough
    
    for (let i = 0; i < maxAttempts && questions.length < n; i++) {
      const regexQ = generateRegexQuestion(keyTerms, text, rng);
      if (regexQ && !usedContent.has(regexQ.q)) {
        usedContent.add(regexQ.q);
        questions.push(regexQ);
      }
    }
    
    // If we have enough regex questions, return them directly
    if (questions.length >= n) {
      console.log(`Generated ${questions.length} regex questions`);
      return questions.slice(0, n);
    }
    
    console.log(`Only generated ${questions.length} regex questions, need ${n - questions.length} more`);
  }
  
  // Question type generators
  const generators = [
    () => generateDefinitionQuestion(keyTerms, text, rng),
    () => generateFillInBlankQuestion(sentences, rng),
    () => generateConceptualQuestion(keyTerms, text, rng),
    () => generateComparisonQuestion(keyTerms, text, rng),
    () => generateApplicationQuestion(keyTerms, text, rng),
    () => generateRegexQuestion(keyTerms, text, rng),
    () => generateCodePatternQuestion(keyTerms, text, rng)
  ];
  
  // Generate diverse questions
  for (let attempts = 0; attempts < n * 3 && questions.length < n; attempts++) {
    const generatorIndex = Math.floor(rng() * generators.length);
    const question = generators[generatorIndex]();
    
    if (question && !usedContent.has(question.q)) {
      usedContent.add(question.q);
      questions.push(question);
    }
  }
  
  // Fill remaining with enhanced generic questions if needed
  while (questions.length < n) {
    const genericQ = generateEnhancedGenericQuestion(questions.length + 1, keyTerms);
    questions.push(genericQ);
  }
  
  return questions.slice(0, n);
}

function extractKeyTerms(text) {
  const stopWords = new Set(['the', 'a', 'an', 'and', 'or', 'but', 'in', 'on', 'at', 'to', 'for', 'of', 'with', 'by', 'from', 'is', 'are', 'was', 'were', 'be', 'been', 'being', 'have', 'has', 'had', 'do', 'does', 'did', 'will', 'would', 'could', 'should', 'may', 'might', 'can', 'this', 'that', 'these', 'those', 'page']);
  
  // First extract regex patterns and code snippets
  const regexPatterns = extractRegexPatterns(text);
  const codeTerms = extractCodeTerms(text);
  
  // Extract regular words that appear frequently and are likely important
  const words = text.toLowerCase()
    .replace(/[^\w\s]/g, ' ')
    .split(/\s+/)
    .filter(word => word.length > 3 && !stopWords.has(word) && !/^\d+$/.test(word));
  
  const wordCount = {};
  words.forEach(word => {
    wordCount[word] = (wordCount[word] || 0) + 1;
  });
  
  // Get terms that appear multiple times, suggesting importance
  const regularTerms = Object.entries(wordCount)
    .filter(([word, count]) => count >= 2)
    .sort((a, b) => b[1] - a[1])
    .slice(0, 40)
    .map(([word]) => word);
  
  // Combine regular terms with regex patterns and code terms
  return [...regularTerms, ...regexPatterns, ...codeTerms].slice(0, 50);
}

function extractRegexPatterns(text) {
  const patterns = [];
  
  // Common regex pattern formats
  const regexFormats = [
    // Patterns between forward slashes: /pattern/flags
    /\/([^\/\n]{2,50})\/[gimsuxy]*/g,
    // Patterns in quotes that look like regex
    /['"]\s*([\\^$.*+?{}()|[\]]{2,}[^'"]*)\s*['"]/g,
    // Common regex symbols in educational context
    /([\\^$.*+?{}()|[\]]+)/g
  ];
  
  regexFormats.forEach(regex => {
    let match;
    while ((match = regex.exec(text)) !== null) {
      const pattern = match[1] || match[0];
      if (pattern && pattern.length >= 2 && pattern.length <= 50) {
        patterns.push(pattern.trim());
      }
    }
  });
  
  // Also look for common regex metacharacters and quantifiers
  const regexTerms = [
    '.*', '.+', '.?', '^', '$', '\\d', '\\w', '\\s', 
    '*', '+', '?', '{n}', '{n,}', '{n,m}', 
    '[a-z]', '[0-9]', '[^]', '()', '|', '\\'
  ];
  
  regexTerms.forEach(term => {
    if (text.includes(term)) {
      patterns.push(term);
    }
  });
  
  return [...new Set(patterns)].slice(0, 10); // Remove duplicates, limit to 10
}

function extractCodeTerms(text) {
  const codeTerms = [];
  
  // Look for programming/technical terms that might get stripped
  const technicalPatterns = [
    // Function calls with parentheses
    /\b(\w+)\s*\([^)]*\)/g,
    // Variable assignments
    /\b(\w+)\s*=\s*[^;,\n]+/g,
    // Method calls with dots
    /\b(\w+\.\w+)/g,
    // Common programming constructs
    /\b(if|else|for|while|function|class|return|var|let|const|def|import|export)\b/g
  ];
  
  technicalPatterns.forEach(pattern => {
    let match;
    while ((match = pattern.exec(text)) !== null) {
      const term = match[1];
      if (term && term.length >= 2 && term.length <= 30) {
        codeTerms.push(term);
      }
    }
  });
  
  return [...new Set(codeTerms)].slice(0, 10); // Remove duplicates, limit to 10
}

function extractGoodSentences(text) {
  return text.split(/(?<=[\.\?\!])\s+/)
    .filter(s => s.length > 40 && s.length < 200)
    .filter(s => !s.match(/^(page|chapter|\d+|figure|table|file:|=====|pdf)/i))
    .filter(s => !s.includes('===== FILE:'))
    .filter(s => !s.includes('# Page'))
    .slice(0, 100); // Limit for performance
}

function generateDefinitionQuestion(keyTerms, text, rng) {
  if (keyTerms.length === 0) return null;
  
  // Filter out file paths, page references, and URLs
  const cleanTerms = keyTerms.filter(term => 
    !term.includes('file:') && 
    !term.includes('page') && 
    !term.includes('.com') && 
    !term.includes('.org') &&
    !term.includes('=====') &&
    term.length > 2 && 
    term.length < 30 &&
    !/^[^\w]*$/.test(term) // Not just special characters
  );
  
  if (cleanTerms.length === 0) return null;
  
  const term = cleanTerms[Math.floor(rng() * Math.min(cleanTerms.length, 15))];
  
  // Skip if term appears to be meaningless or just fragments
  if (/^(pdf|===|page|\d+)$/i.test(term)) return null;
  
  const templates = [
    `What does the term "${term}" refer to in this context?`,
    `In the context of these slides, "${term}" is best defined as:`,
    `The concept of "${term}" can be described as:`,
    `According to the material, "${term}" means:`
  ];
  
  const question = templates[Math.floor(rng() * templates.length)];
  
  // Generate clean, educational options
  const cleanOptions = [
    `A fundamental concept in the subject matter`,
    `An important technical term discussed in the material`,
    `A key component of the system being studied`,
    `A method or approach used in this field`
  ];
  
  const opts = shuffle(cleanOptions, rng);
  
  return {
    q: question,
    opts: opts,
    ans: 0,
    exp: `The term "${term}" is an important concept covered in the slide material.`
  };
}

function generateFillInBlankQuestion(sentences, rng) {
  if (sentences.length === 0) return null;
  
  const sentence = sentences[Math.floor(rng() * sentences.length)];
  const words = sentence.split(/\s+/);
  
  // Find a good word to blank out (avoid articles, prepositions, etc.)
  const meaningfulWords = words.map((word, index) => ({word, index}))
    .filter(({word}) => word.length > 4 && !/^(the|and|with|from|that|this|they|have|been|will|would)$/i.test(word))
    .filter(({word}) => !/^\d+$/.test(word));
  
  if (meaningfulWords.length === 0) return null;
  
  const {word: targetWord, index: targetIndex} = meaningfulWords[Math.floor(rng() * meaningfulWords.length)];
  const cleanWord = targetWord.replace(/[^\w]/g, '');
  
  // Create the question with blank
  const questionWords = [...words];
  questionWords[targetIndex] = '_____';
  const questionText = questionWords.join(' ').replace(/\s+/g, ' ').trim();
  
  // Generate distractors
  const distractors = [
    'analysis', 'process', 'method', 'system', 'approach', 'concept', 
    'principle', 'technique', 'strategy', 'framework', 'model', 'theory',
    'structure', 'function', 'component', 'element', 'factor', 'aspect'
  ].filter(d => d.toLowerCase() !== cleanWord.toLowerCase())
   .sort(() => rng() - 0.5)
   .slice(0, 3);
  
  const opts = shuffle([cleanWord, ...distractors], rng);
  const ansIndex = opts.findIndex(opt => opt.toLowerCase() === cleanWord.toLowerCase());
  
  return {
    q: `Complete the following statement: ${questionText}`,
    opts: opts,
    ans: ansIndex,
    exp: `This sentence appears in the slides, and "${cleanWord}" is the correct term used in this context.`
  };
}

function generateConceptualQuestion(keyTerms, text, rng) {
  if (keyTerms.length < 2) return null;
  
  const primaryTerm = keyTerms[Math.floor(rng() * Math.min(keyTerms.length, 10))];
  
  const templates = [
    `Which of the following is most closely related to ${primaryTerm}?`,
    `In the context of ${primaryTerm}, which concept is most important?`,
    `What is a key characteristic of ${primaryTerm}?`,
    `Which statement best describes ${primaryTerm}?`
  ];
  
  const question = templates[Math.floor(rng() * templates.length)];
  
  // Find related terms from the text
  const relatedTerms = findRelatedTerms(primaryTerm, text, keyTerms);
  const correctAnswer = relatedTerms.length > 0 ? relatedTerms[0] : primaryTerm + ' implementation';
  
  const distractors = generateConceptualDistractors(primaryTerm, keyTerms, rng);
  
  const opts = shuffle([correctAnswer, ...distractors], rng);
  const ansIndex = opts.findIndex(opt => opt === correctAnswer);
  
  return {
    q: question,
    opts: opts,
    ans: ansIndex,
    exp: `Based on the slide content, this option is most closely associated with ${primaryTerm}.`
  };
}

function generateComparisonQuestion(keyTerms, text, rng) {
  if (keyTerms.length < 4) return null;
  
  const terms = shuffle([...keyTerms], rng).slice(0, 4);
  const primaryTerm = terms[0];
  
  const templates = [
    `Which of the following is most similar to ${primaryTerm}?`,
    `Compared to other concepts, ${primaryTerm} is most like:`,
    `What shares the most characteristics with ${primaryTerm}?`
  ];
  
  const question = templates[Math.floor(rng() * templates.length)];
  const opts = terms.slice(1);
  
  return {
    q: question,
    opts: shuffle(opts, rng),
    ans: 0, // First option after shuffle
    exp: `Based on the content, these concepts share similar characteristics or contexts.`
  };
}

function generateApplicationQuestion(keyTerms, text, rng) {
  if (keyTerms.length === 0) return null;
  
  const term = keyTerms[Math.floor(rng() * Math.min(keyTerms.length, 15))];
  
  const templates = [
    `How would ${term} typically be applied in practice?`,
    `What is the primary use case for ${term}?`,
    `When would you most likely encounter ${term}?`,
    `In what scenario is ${term} most relevant?`
  ];
  
  const question = templates[Math.floor(rng() * templates.length)];
  
  const applicationOptions = [
    `In ${term} implementation and analysis`,
    `During ${term} evaluation processes`,
    `For ${term} optimization and improvement`,
    `When developing ${term} strategies`
  ];
  
  const opts = shuffle(applicationOptions, rng);
  
  return {
    q: question,
    opts: opts,
    ans: 0,
    exp: `This application context aligns with how ${term} is discussed in the slide material.`
  };
}

function generateSmartDistractors(term, keyTerms, rng) {
  const genericDistractors = [
    'A type of measurement tool',
    'A statistical methodology',
    'A data processing technique',
    'A theoretical framework',
    'An analytical approach',
    'A systematic process',
    'A conceptual model',
    'A research method'
  ];
  
  // Mix related terms and generic distractors
  const relatedTermDistractors = keyTerms
    .filter(t => t !== term)
    .sort(() => rng() - 0.5)
    .slice(0, 2)
    .map(t => `Related to ${t} processes`);
  
  const allDistractors = [...genericDistractors, ...relatedTermDistractors];
  return shuffle(allDistractors, rng).slice(0, 3);
}

function generateCorrectDefinition(term, context) {
  // Try to extract a reasonable definition from context
  if (context && context.includes(term)) {
    return `A concept that appears in the context of ${context.substring(0, 50)}...`;
  }
  return `A key concept discussed in the slide material`;
}

function findRelatedTerms(primaryTerm, text, keyTerms) {
  // Find terms that appear near the primary term in the text
  const sentences = text.toLowerCase().split(/[\.\!\?]/);
  const relatedTerms = [];
  
  for (const sentence of sentences) {
    if (sentence.includes(primaryTerm)) {
      for (const term of keyTerms) {
        if (term !== primaryTerm && sentence.includes(term)) {
          relatedTerms.push(term);
        }
      }
    }
  }
  
  return [...new Set(relatedTerms)]; // Remove duplicates
}

function generateConceptualDistractors(primaryTerm, keyTerms, rng) {
  const concepts = [
    'data analysis framework',
    'measurement methodology',
    'processing algorithm',
    'evaluation criteria',
    'implementation strategy',
    'optimization technique'
  ];
  
  return shuffle(concepts, rng).slice(0, 3);
}

function generateEnhancedGenericQuestion(questionNum, keyTerms) {
  const hasKeyTerms = keyTerms.length > 0;
  const randomTerm = hasKeyTerms ? keyTerms[Math.floor(Math.random() * keyTerms.length)] : 'concept';
  
  const questions = [
    {
      q: hasKeyTerms ? `What is an important aspect of ${randomTerm}?` : 'What is a fundamental principle in academic study?',
      opts: ['Systematic analysis and understanding', 'Quick completion', 'Personal preference', 'Random selection'],
      ans: 0,
      exp: 'Systematic analysis and thorough understanding are key to academic success.'
    },
    {
      q: hasKeyTerms ? `How should ${randomTerm} be approached?` : 'What characterizes effective learning?',
      opts: ['Through careful study and analysis', 'By memorizing details only', 'By avoiding complexity', 'Through rapid completion'],
      ans: 0,
      exp: 'Careful study and analysis lead to deeper understanding and better outcomes.'
    },
    {
      q: hasKeyTerms ? `What makes ${randomTerm} effective?` : 'What makes academic work valuable?',
      opts: ['Thorough preparation and methodology', 'Speed of completion', 'Length of content', 'Complexity of language'],
      ans: 0,
      exp: 'Thorough preparation and sound methodology are foundations of effective academic work.'
    }
  ];
  
  return questions[(questionNum - 1) % questions.length];
}

function generateRegexQuestion(keyTerms, text, rng) {
  // Check if the text appears to be about regex by looking for regex keywords
  const isRegexContext = /regex|regular\s+expression|pattern|match|character\s+class|quantifier|metacharacter|anchor|backslash|escape|literal|wildcard|dot|caret|dollar|pipe|alternation|group|capture|bracket|brace|parenthes|repetition|greedy|lazy|pythex|regexper|string|text/i.test(text);
  
  // Also check for actual regex patterns in the text
  const hasRegexPatterns = /[\\^$.*+?{}()|[\]]+|\\[dwsWDS]|\[[^\]]+\]/.test(text);
  
  if (!isRegexContext && !hasRegexPatterns) return null;
  
  // High-quality regex questions based on common patterns
  const regexQuestions = [
    {
      q: "What does the regular expression [a-z] match?",
      opts: ["Any lowercase letter from a to z", "The characters a and z only", "All characters between the ranges a to z and A to Z", "All characters between the range a to z"],
      ans: 0,
      exp: "Character classes like [a-z] match any single character within the specified range, in this case any lowercase letter."
    },
    {
      q: "Which of these will match the strings revolution, revolutionary, and revolutionaries?",
      opts: ["revolution[a-z]*", "revolution[a-z]?", "revolution[a-z]+", "revolution[a-z]{1,3}"],
      ans: 0,
      exp: "The * quantifier matches zero or more of the preceding element, allowing for any number of additional lowercase letters after 'revolution'."
    },
    {
      q: "Which of these will match the strings revolution, Revolution, and their plural variants only?",
      opts: ["[rR]evolution[s]?", "revolution[s]+", "[rR]evolution[s]+", "[rR]evolution[s]*"],
      ans: 0,
      exp: "The [rR] matches either 'r' or 'R', and [s]? matches an optional 's' for plurals."
    },
    {
      q: "What regular expression matches the strings dog or cat?",
      opts: ["dog|cat", "dog,cat", "dog | cat", "[dog][cat]"],
      ans: 0,
      exp: "The pipe symbol | represents alternation, matching either the pattern before or after it."
    },
    {
      q: "What regular expression matches the whole words dog or cat?",
      opts: ["\\bdog|cat\\b", "\\bdog\\b | \\bcat\\b", "\\bdog\\b|\\bcat\\b", "dog|cat"],
      ans: 2,
      exp: "Word boundaries \\b ensure we match complete words, and the alternation | must be properly grouped."
    },
    {
      q: "What do we put after a character to match strings where that character appears two to four times in sequence?",
      opts: ["{2,4}", "{2-4}", "[2,4]", "(2,4)"],
      ans: 0,
      exp: "Curly braces {} specify exact repetition counts, with {2,4} meaning 2 to 4 occurrences."
    },
    {
      q: "What does the + quantifier mean in regular expressions?",
      opts: ["One or more occurrences", "Zero or more occurrences", "Zero or one occurrence", "Exactly one occurrence"],
      ans: 0,
      exp: "The + quantifier matches one or more instances of the preceding element."
    },
    {
      q: "What does the * quantifier mean in regular expressions?",
      opts: ["Zero or more occurrences", "One or more occurrences", "Zero or one occurrence", "Exactly one occurrence"],
      ans: 0,
      exp: "The * quantifier matches zero or more instances of the preceding element."
    },
    {
      q: "What does the ? quantifier mean in regular expressions?",
      opts: ["Zero or one occurrence (optional)", "One or more occurrences", "Zero or more occurrences", "Any number of occurrences"],
      ans: 0,
      exp: "The ? quantifier makes the preceding element optional, matching zero or one occurrence."
    },
    {
      q: "What does \\d represent in regular expressions?",
      opts: ["Any digit character (0-9)", "Any letter character", "Any whitespace character", "Any special character"],
      ans: 0,
      exp: "\\d is a shorthand character class that matches any digit from 0 to 9."
    },
    {
      q: "What does \\w represent in regular expressions?",
      opts: ["Word characters (letters, digits, underscore)", "Whitespace characters only", "Any character", "Numbers only"],
      ans: 0,
      exp: "\\w matches word characters, which include letters, digits, and underscore."
    },
    {
      q: "What does \\s represent in regular expressions?",
      opts: ["Whitespace characters (space, tab, newline)", "Any letter character", "Any digit character", "Special characters"],
      ans: 0,
      exp: "\\s matches any whitespace character including spaces, tabs, and newlines."
    },
    {
      q: "What does the ^ symbol represent in regular expressions?",
      opts: ["Start of line or string", "End of line or string", "Any character", "Negation in character class"],
      ans: 0,
      exp: "^ is an anchor that matches the beginning of a line or string."
    },
    {
      q: "What does the $ symbol represent in regular expressions?",
      opts: ["End of line or string", "Start of line or string", "Any character", "Dollar sign literal"],
      ans: 0,
      exp: "$ is an anchor that matches the end of a line or string."
    },
    {
      q: "What does [^abc] match in regular expressions?",
      opts: ["Any character except a, b, or c", "The characters a, b, and c", "The start of line followed by abc", "Any character including a, b, or c"],
      ans: 0,
      exp: "^ inside character brackets negates the character class, matching any character NOT in the set."
    },
    {
      q: "What does the . (dot) represent in regular expressions?",
      opts: ["Any character except newline", "A literal dot", "Any digit", "Any letter"],
      ans: 0,
      exp: "The dot is a metacharacter that matches any single character except newline."
    },
    {
      q: "How do you match a literal dot (.) in a regular expression?",
      opts: ["\\.", "[.]", "\\\\.", "dot"],
      ans: 0,
      exp: "To match a literal dot, you must escape it with a backslash: \\."
    },
    {
      q: "What does [0-9] match in regular expressions?",
      opts: ["Any digit from 0 to 9", "The numbers 0 and 9 only", "Any number", "Any character"],
      ans: 0,
      exp: "Character class [0-9] matches any single digit character from 0 to 9."
    },
    {
      q: "Which pattern matches one or more digits?",
      opts: ["\\d+", "\\d*", "\\d?", "\\d{1}"],
      ans: 0,
      exp: "\\d+ matches one or more digit characters (\\d means digit, + means one or more)."
    },
    {
      q: "What does the pattern ^abc$ match?",
      opts: ["Exactly 'abc' as the complete string", "Any string containing 'abc'", "Strings starting with 'abc'", "Strings ending with 'abc'"],
      ans: 0,
      exp: "^ and $ are anchors that match start and end of string, so ^abc$ matches exactly 'abc'."
    },
    {
      q: "How do you create a character class that matches any vowel?",
      opts: ["[aeiou]", "(a|e|i|o|u)", "\\v", "[vowels]"],
      ans: 0,
      exp: "Character classes use square brackets [aeiou] to match any single character in the set."
    },
    {
      q: "What does \\b represent in regular expressions?",
      opts: ["Word boundary", "Backspace character", "Bold text", "Beginning of string"],
      ans: 0,
      exp: "\\b is a word boundary assertion that matches between word and non-word characters."
    },
    {
      q: "Which quantifier makes the preceding element optional?",
      opts: ["?", "*", "+", "{0,1}"],
      ans: 0,
      exp: "The ? quantifier matches zero or one occurrence, making the element optional."
    },
    {
      q: "What does [^0-9] match?",
      opts: ["Any character except digits", "Any digit", "The caret symbol followed by digits", "Numbers from 0 to 9"],
      ans: 0,
      exp: "The caret ^ inside brackets negates the character class, matching anything except digits."
    },
    {
      q: "How do you match exactly 3 digits in a row?",
      opts: ["\\d{3}", "\\d*3", "\\d+3", "[0-9]3"],
      ans: 0,
      exp: "Curly braces specify exact repetition count: \\d{3} matches exactly 3 digits."
    },
    {
      q: "What is the difference between * and + quantifiers?",
      opts: ["* includes zero occurrences, + requires at least one", "* is greedy, + is lazy", "* matches more, + matches less", "No difference"],
      ans: 0,
      exp: "* matches zero or more (including none), while + requires at least one occurrence."
    },
    {
      q: "Which pattern matches a valid email format (basic)?",
      opts: ["\\w+@\\w+\\.\\w+", "\\w*@\\w*\\.\\w*", "[a-z]+@[a-z]+\\.[a-z]+", "\\S+@\\S+\\.\\S+"],
      ans: 0,
      exp: "\\w+@\\w+\\.\\w+ matches word characters, @, domain, literal dot (escaped), and extension."
    },
    {
      q: "What does \\W (capital W) represent?",
      opts: ["Non-word characters", "Word characters", "Whitespace", "Any character"],
      ans: 0,
      exp: "\\W is the complement of \\w, matching any character that is NOT a word character."
    },
    {
      q: "How do you match a phone number like 123-456-7890?",
      opts: ["\\d{3}-\\d{3}-\\d{4}", "\\d*-\\d*-\\d*", "[0-9]+-[0-9]+-[0-9]+", "\\w{3}-\\w{3}-\\w{4}"],
      ans: 0,
      exp: "\\d{3}-\\d{3}-\\d{4} matches exactly 3 digits, hyphen, 3 digits, hyphen, 4 digits."
    },
    // Multiple answer questions
    {
      q: "Which of the following are valid regex quantifiers? (Select all that apply)",
      opts: ["*", "+", "?", "{n,m}"],
      ans: [0, 1, 2, 3],
      multiple: true,
      exp: "All of these are valid quantifiers: * (zero or more), + (one or more), ? (zero or one), {n,m} (between n and m)."
    },
    {
      q: "Which patterns will match the string 'cat'? (Select all that apply)",
      opts: ["cat", "c.t", "[cat]{3}", "c[aeiou]t"],
      ans: [0, 1, 3],
      multiple: true,
      exp: "'cat' matches literally, 'c.t' matches with any character in middle, 'c[aeiou]t' matches with vowels. '[cat]{3}' matches any 3 characters from the set, not the word."
    },
    {
      q: "Which of these represent whitespace in regex? (Select all that apply)",
      opts: ["\\s", " ", "\\t", "\\n"],
      ans: [0, 1, 2, 3],
      multiple: true,
      exp: "\\s matches any whitespace, space is literal space, \\t is tab, \\n is newline - all represent whitespace."
    },
    {
      q: "Which patterns match one or more digits? (Select all that apply)",
      opts: ["\\d+", "[0-9]+", "\\d{1,}", "[0-9]{1,}"],
      ans: [0, 1, 2, 3],
      multiple: true,
      exp: "All these patterns match one or more digits: \\d+ and [0-9]+ use the + quantifier, while {1,} means 'one or more'."
    },
    {
      q: "Which are valid ways to escape special characters? (Select all that apply)",
      opts: ["\\.", "\\*", "\\+", "\\{"],
      ans: [0, 1, 2, 3],
      multiple: true,
      exp: "All special regex characters should be escaped with backslash to match them literally."
    },
    {
      q: "Which patterns will match 'abc' at the start of a line? (Select all that apply)",
      opts: ["^abc", "^abc.*", "abc", ".*abc"],
      ans: [0, 1],
      multiple: true,
      exp: "^abc and ^abc.* both use the ^ anchor to match at start of line. Plain 'abc' and '.*abc' can match anywhere."
    }
  ];
  
  // Select a random question
  const selectedQuestion = regexQuestions[Math.floor(rng() * regexQuestions.length)];
  
  if (selectedQuestion.multiple) {
    // For multiple answer questions, keep original order and return array of correct indices
    return {
      q: selectedQuestion.q,
      opts: selectedQuestion.opts,
      ans: selectedQuestion.ans,
      multiple: true,
      exp: selectedQuestion.exp
    };
  } else {
    // For single answer questions, shuffle as before
    const correctAnswer = selectedQuestion.opts[selectedQuestion.ans];
    const shuffledOptions = shuffle([...selectedQuestion.opts], rng);
    const correctIndex = shuffledOptions.findIndex(opt => opt === correctAnswer);
    
    return {
      q: selectedQuestion.q,
      opts: shuffledOptions,
      ans: correctIndex,
      exp: selectedQuestion.exp
    };
  }
}

function generateCodePatternQuestion(keyTerms, text, rng) {
  // Check if this appears to be programming content, but exclude URLs
  const isProgrammingContext = /programming|code|function|algorithm|syntax|variable|array|object|method/i.test(text);
  
  if (!isProgrammingContext) return null;
  
  // Find actual programming terms, excluding URLs and website names
  const codeTerms = keyTerms.filter(term => 
    /\(\)/.test(term) && 
    !term.includes('.com') && 
    !term.includes('.org') &&
    !term.includes('http') &&
    term.length < 20 // Reasonable function name length
  );
  
  // If no actual code terms found, generate general programming questions
  const programmingQuestions = [
    {
      q: 'What does the dot notation (.) typically represent in programming?',
      opts: ['Object property or method access', 'Mathematical multiplication', 'String concatenation', 'Variable declaration'],
      ans: 0,
      exp: 'Dot notation is commonly used to access properties or methods of objects.'
    },
    {
      q: 'Which of these is a common programming pattern?',
      opts: ['function()', 'variable = value', 'if condition', 'All of the above'],
      ans: 3,
      exp: 'All of these represent fundamental programming patterns used in most languages.'
    },
    {
      q: 'What are variables typically used for in programming?',
      opts: ['Storing and manipulating data', 'Creating visual interfaces', 'Network communication', 'File compression'],
      ans: 0,
      exp: 'Variables are fundamental data containers in programming languages.'
    },
    {
      q: 'What is the purpose of functions in programming?',
      opts: ['Organizing code into reusable blocks', 'Displaying graphics', 'Managing memory', 'Handling user input'],
      ans: 0,
      exp: 'Functions allow code to be organized into reusable, modular blocks.'
    },
    {
      q: 'What does an algorithm represent in programming?',
      opts: ['A step-by-step procedure to solve a problem', 'A programming language', 'A data storage method', 'A user interface design'],
      ans: 0,
      exp: 'An algorithm is a defined sequence of steps to accomplish a task or solve a problem.'
    }
  ];
  
  const selectedQuestion = programmingQuestions[Math.floor(rng() * programmingQuestions.length)];
  
  return {
    q: selectedQuestion.q,
    opts: selectedQuestion.opts,
    ans: selectedQuestion.ans,
    exp: selectedQuestion.exp
  };
}

// ============ Gemini-based generator ============
async function generateSetWithGemini(slidesText, perSet, apikey, temperature=0.7){
  // Check if we have sufficient content for AI generation
  if (!slidesText || slidesText.trim().length < 300) {
    console.warn("Insufficient text for AI generation, using fallback");
    return generateGenericQuestions(perSet);
  }

  // Check if this appears to be regex content
  const isRegexContent = /regex|regular\s+expression|pattern|match|character\s+class|quantifier|metacharacter|anchor|backslash|escape|literal|wildcard|dot|caret|dollar|pipe|alternation|group|capture|bracket|brace|parenthes|repetition|greedy|lazy|pythex|regexper/i.test(slidesText);

  const prompt = `Generate ${perSet} multiple-choice questions from the slides content.

${isRegexContent ? 'DETECTED: Regular expressions content. Focus on regex concepts.' : ''}

Return ONLY this JSON format:
{
  "questions": [
    {"q": "Question text", "opts": ["A", "B", "C", "D"], "ans": 0, "exp": "Explanation"},
    {"q": "Multiple choice question (Select all that apply)", "opts": ["A", "B", "C", "D"], "ans": [0, 2], "multiple": true, "exp": "Explanation"}
  ]
}

RULES:
- Return exactly ${perSet} questions
- Mix single answer (ans: number) and multiple answer (ans: array, multiple: true)
- 20-30% should be multiple answer questions  
- Add "(Select all that apply)" for multiple answer questions
- No text outside JSON
- Create educational questions about the content

CONTENT:
${slidesText.substring(0, 12000)}`;

  const payload = {
    contents: [{ role: "user", parts: [{ text: prompt }]}],
    generationConfig: { temperature }
  };
  const resp = await fetch("https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key="+encodeURIComponent(apikey), {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify(payload)
  });
  if (!resp.ok){
    throw new Error(await resp.text());
  }
  const data = await resp.json();
  let text = (data && data.candidates && data.candidates[0] && data.candidates[0].content && data.candidates[0].content.parts && data.candidates[0].content.parts[0].text) || "";
  
  // Clean up the response text more thoroughly
  text = text.replace(/^```json\s*|\s*```$/g, "");
  text = text.replace(/^```\s*|\s*```$/g, "");
  
  // Try to extract JSON if it's embedded in other text
  const jsonMatch = text.match(/\{[\s\S]*"questions"[\s\S]*\]/);
  if (jsonMatch) {
    text = jsonMatch[0];
    // Find the closing brace for the main object
    let braceCount = 0;
    let endIndex = -1;
    for (let i = 0; i < text.length; i++) {
      if (text[i] === '{') braceCount++;
      if (text[i] === '}') {
        braceCount--;
        if (braceCount === 0) {
          endIndex = i;
          break;
        }
      }
    }
    if (endIndex > 0) {
      text = text.substring(0, endIndex + 1);
    }
  }
  
  let parsed;
  try{ 
    parsed = JSON.parse(text); 
  } catch(e){ 
    console.error("Failed to parse JSON from Gemini:", e.message);
    console.error("Raw response:", text.slice(0, 1000));
    
    // Try to fix common JSON issues
    let fixedText = text;
    
    // Remove any text before the first {
    const firstBrace = fixedText.indexOf('{');
    if (firstBrace > 0) {
      fixedText = fixedText.substring(firstBrace);
    }
    
    // Remove any text after the last }
    const lastBrace = fixedText.lastIndexOf('}');
    if (lastBrace >= 0) {
      fixedText = fixedText.substring(0, lastBrace + 1);
    }
    
    // Try parsing the cleaned text
    try {
      parsed = JSON.parse(fixedText);
      console.log("Successfully parsed cleaned JSON");
    } catch(e2) {
      console.error("Failed to parse cleaned JSON:", e2.message);
      console.warn("Falling back to heuristic generation due to JSON parse error");
      return heuristicGenerate(slidesText, perSet, seededRandom(Date.now().toString()));
    }
  }
  
  // Validate the parsed structure
  if (!parsed) {
    console.error("Parsed object is null/undefined");
    return heuristicGenerate(slidesText, perSet, seededRandom(Date.now().toString()));
  }
  
  if (!parsed.questions) {
    console.error("Missing 'questions' property. Available properties:", Object.keys(parsed));
    // Maybe it's a flat array?
    if (Array.isArray(parsed)) {
      console.log("Response is a flat array, trying to wrap it");
      parsed = { questions: parsed };
    } else {
      console.warn("Falling back to heuristic generation - no questions found");
      return heuristicGenerate(slidesText, perSet, seededRandom(Date.now().toString()));
    }
  }
  
  if (!Array.isArray(parsed.questions)) {
    console.error("'questions' is not an array:", typeof parsed.questions);
    return heuristicGenerate(slidesText, perSet, seededRandom(Date.now().toString()));
  }
  parsed.questions = parsed.questions.map(q => ({
    q: String(q.q||"").trim(),
    opts: Array.isArray(q.opts) && q.opts.length>=2 ? q.opts.map(String) : ["A","B","C","D"],
    ans: q.multiple && Array.isArray(q.ans) ? q.ans : (Number.isInteger(q.ans) ? q.ans : 0),
    multiple: q.multiple || false,
    exp: String(q.exp||"").trim()
  }));
  if (parsed.questions.length !== perSet){
    const need = perSet - parsed.questions.length;
    if (need > 0){
      for (let i=0;i<need;i++){
        parsed.questions.push({
          q:"Filler question (generation count adjusted).",
          opts:["Option A","Option B","Option C","Option D"], ans:0,
          exp:"Added to reach requested count."
        });
      }
    } else {
      parsed.questions = parsed.questions.slice(0, perSet);
    }
  }
  return parsed.questions;
}

// ============ State ============
let SLIDES_TEXT = "";
let QUIZ_SETS = [];   // array of sets; each set is array of {q,opts,ans,exp}
let ACTIVE_INDEX = -1;
let START_TIME = Date.now();
let RNG = Math.random;
let LAST_RESULTS = []; // for CSV export

// ============ Progress Tracking ============
let PROGRESS_DATA = {
  sessions: [],
  topicStats: {},
  totalAttempts: 0,
  totalScore: 0,
  bestStreak: 0,
  currentStreak: 0
};

function loadProgressData() {
  try {
    const saved = localStorage.getItem('quiz_progress_data');
    if (saved) {
      PROGRESS_DATA = { ...PROGRESS_DATA, ...JSON.parse(saved) };
      console.log('Progress data loaded');
    }
  } catch (e) {
    console.warn('Failed to load progress data:', e);
  }
}

function saveProgressData() {
  try {
    localStorage.setItem('quiz_progress_data', JSON.stringify(PROGRESS_DATA));
  } catch (e) {
    console.warn('Failed to save progress data:', e);
  }
}

function detectTopic(slidesText, fileName) {
  const text = slidesText.toLowerCase();
  
  // Detect specific topics based on content
  if (/regex|regular\s+expression|pattern|match|quantifier|metacharacter/i.test(text)) {
    return 'Regular Expressions';
  } else if (/javascript|js|function|variable|array|object/i.test(text)) {
    return 'JavaScript';
  } else if (/python|def|import|class|list|dict/i.test(text)) {
    return 'Python';
  } else if (/html|css|tag|element|style|selector/i.test(text)) {
    return 'Web Development';
  } else if (/database|sql|query|table|select/i.test(text)) {
    return 'Database';
  } else if (/algorithm|data\s+structure|sort|search|complexity/i.test(text)) {
    return 'Algorithms';
  } else if (fileName) {
    // Fall back to filename-based detection
    const name = fileName.toLowerCase();
    if (name.includes('regex') || name.includes('expression')) return 'Regular Expressions';
    if (name.includes('js') || name.includes('javascript')) return 'JavaScript';
    if (name.includes('python') || name.includes('py')) return 'Python';
    if (name.includes('web') || name.includes('html')) return 'Web Development';
    if (name.includes('database') || name.includes('sql')) return 'Database';
    if (name.includes('algorithm')) return 'Algorithms';
    
    // Extract topic from week/chapter patterns
    const weekMatch = name.match(/week\s*(\d+)|chapter\s*(\d+)/);
    if (weekMatch) {
      return `Week ${weekMatch[1] || weekMatch[2]} Content`;
    }
  }
  
  return 'General Study';
}

function recordQuizSession(topic, score, totalQuestions, timeSpent, questionDetails) {
  const session = {
    id: Date.now(),
    timestamp: new Date().toISOString(),
    topic: topic,
    score: score,
    totalQuestions: totalQuestions,
    percentage: Math.round((score / totalQuestions) * 100),
    timeSpent: timeSpent,
    questionDetails: questionDetails,
    date: new Date().toLocaleDateString()
  };
  
  // Add to sessions
  PROGRESS_DATA.sessions.unshift(session); // Most recent first
  
  // Keep only last 100 sessions to avoid storage bloat
  if (PROGRESS_DATA.sessions.length > 100) {
    PROGRESS_DATA.sessions = PROGRESS_DATA.sessions.slice(0, 100);
  }
  
  // Update topic stats
  if (!PROGRESS_DATA.topicStats[topic]) {
    PROGRESS_DATA.topicStats[topic] = {
      attempts: 0,
      totalScore: 0,
      totalQuestions: 0,
      bestScore: 0,
      averageTime: 0,
      weakAreas: {},
      lastAttempt: null
    };
  }
  
  const topicStat = PROGRESS_DATA.topicStats[topic];
  topicStat.attempts++;
  topicStat.totalScore += score;
  topicStat.totalQuestions += totalQuestions;
  topicStat.bestScore = Math.max(topicStat.bestScore, session.percentage);
  topicStat.averageTime = Math.round((topicStat.averageTime * (topicStat.attempts - 1) + timeSpent) / topicStat.attempts);
  topicStat.lastAttempt = session.timestamp;
  
  // Track weak areas (questions answered incorrectly)
  questionDetails.forEach(q => {
    if (!q.correct) {
      const concept = extractConcept(q.question);
      if (!topicStat.weakAreas[concept]) {
        topicStat.weakAreas[concept] = { count: 0, questions: [] };
      }
      topicStat.weakAreas[concept].count++;
      topicStat.weakAreas[concept].questions.push({
        question: q.question,
        yourAnswer: q.selectedAnswer,
        correctAnswer: q.correctAnswer,
        timestamp: session.timestamp
      });
    }
  });
  
  // Update global stats
  PROGRESS_DATA.totalAttempts++;
  PROGRESS_DATA.totalScore += score;
  
  // Update streak
  if (session.percentage >= 70) { // 70% threshold for maintaining streak
    PROGRESS_DATA.currentStreak++;
    PROGRESS_DATA.bestStreak = Math.max(PROGRESS_DATA.bestStreak, PROGRESS_DATA.currentStreak);
  } else {
    PROGRESS_DATA.currentStreak = 0;
  }
  
  saveProgressData();
  return session;
}

function extractConcept(questionText) {
  const text = questionText.toLowerCase();
  
  // Regex concepts
  if (text.includes('quantifier')) return 'Quantifiers';
  if (text.includes('character class') || text.includes('[')) return 'Character Classes';
  if (text.includes('anchor') || text.includes('^') || text.includes('$')) return 'Anchors';
  if (text.includes('escape') || text.includes('\\')) return 'Escaping';
  if (text.includes('group') || text.includes('()')) return 'Groups';
  if (text.includes('alternation') || text.includes('|')) return 'Alternation';
  
  // Programming concepts
  if (text.includes('function')) return 'Functions';
  if (text.includes('variable')) return 'Variables';
  if (text.includes('array') || text.includes('list')) return 'Arrays/Lists';
  if (text.includes('object')) return 'Objects';
  if (text.includes('loop')) return 'Loops';
  
  return 'General Concepts';
}

function getProgressInsights() {
  const insights = {
    totalSessions: PROGRESS_DATA.sessions.length,
    averageScore: PROGRESS_DATA.totalAttempts > 0 ? 
      Math.round((PROGRESS_DATA.totalScore / PROGRESS_DATA.totalAttempts) * 100) / 100 : 0,
    bestStreak: PROGRESS_DATA.bestStreak,
    currentStreak: PROGRESS_DATA.currentStreak,
    topicsStudied: Object.keys(PROGRESS_DATA.topicStats).length,
    recentSessions: PROGRESS_DATA.sessions.slice(0, 5),
    topicPerformance: {},
    weakestAreas: []
  };
  
  // Calculate topic performance
  Object.entries(PROGRESS_DATA.topicStats).forEach(([topic, stats]) => {
    insights.topicPerformance[topic] = {
      attempts: stats.attempts,
      averageScore: stats.totalQuestions > 0 ? 
        Math.round((stats.totalScore / stats.totalQuestions) * 100) : 0,
      bestScore: stats.bestScore,
      averageTime: stats.averageTime,
      lastStudied: stats.lastAttempt
    };
  });
  
  // Find weakest areas across all topics
  const allWeakAreas = [];
  Object.entries(PROGRESS_DATA.topicStats).forEach(([topic, stats]) => {
    Object.entries(stats.weakAreas).forEach(([concept, data]) => {
      allWeakAreas.push({
        topic,
        concept,
        errorCount: data.count,
        recentErrors: data.questions.slice(-3) // Last 3 errors
      });
    });
  });
  
  insights.weakestAreas = allWeakAreas
    .sort((a, b) => b.errorCount - a.errorCount)
    .slice(0, 5); // Top 5 weakest areas
  
  return insights;
}

function showProgressDashboard() {
  const insights = getProgressInsights();
  
  // Check if user has any progress data
  if (insights.totalSessions === 0) {
    const noDataHtml = `
      <div class="progress-dashboard">
        <div class="progress-header">
          <h2>📊 Your Learning Progress</h2>
          <button class="close-btn" onclick="hideProgressDashboard()">✕</button>
        </div>
        
        <div class="no-progress-content">
          <div class="no-progress-icon">📚</div>
          <h3>No Progress Data Yet</h3>
          <p>Complete your first quiz to start tracking your learning progress!</p>
          <div class="progress-features">
            <h4>🎯 What You'll Track:</h4>
            <ul>
              <li>📈 Quiz scores and improvement over time</li>
              <li>📚 Performance by topic (Regex, JavaScript, Python, etc.)</li>
              <li>🎯 Areas that need more practice</li>
              <li>🔥 Learning streaks and achievements</li>
              <li>📊 Detailed session history</li>
            </ul>
          </div>
          <button onclick="hideProgressDashboard()" class="get-started-btn">
            🚀 Get Started - Generate Your First Quiz!
          </button>
        </div>
      </div>
    `;
    
    // Show as overlay
    const overlay = document.createElement('div');
    overlay.className = 'progress-overlay';
    overlay.innerHTML = noDataHtml;
    document.body.appendChild(overlay);
    return;
  }
  
  const progressHtml = `
    <div class="progress-dashboard">
      <div class="progress-header">
        <h2>📊 Your Learning Progress</h2>
        <button class="close-btn" onclick="hideProgressDashboard()">✕</button>
      </div>
      
      <div class="progress-grid">
        <!-- Overall Stats -->
        <div class="progress-card">
          <h3>📈 Overall Performance</h3>
          <div class="stat-grid">
            <div class="stat">
              <span class="stat-value">${insights.totalSessions}</span>
              <span class="stat-label">Total Quizzes</span>
            </div>
            <div class="stat">
              <span class="stat-value">${insights.averageScore.toFixed(1)}</span>
              <span class="stat-label">Avg Score</span>
            </div>
            <div class="stat">
              <span class="stat-value">${insights.currentStreak}</span>
              <span class="stat-label">Current Streak</span>
            </div>
            <div class="stat">
              <span class="stat-value">${insights.bestStreak}</span>
              <span class="stat-label">Best Streak</span>
            </div>
          </div>
        </div>
        
        <!-- Topic Performance -->
        <div class="progress-card">
          <h3>📚 Topic Performance</h3>
          <div class="topic-list">
            ${Object.entries(insights.topicPerformance).map(([topic, stats]) => `
              <div class="topic-item">
                <div class="topic-name">${topic}</div>
                <div class="topic-stats">
                  <span class="topic-score ${stats.averageScore >= 80 ? 'good' : stats.averageScore >= 60 ? 'okay' : 'needs-work'}">${stats.averageScore}%</span>
                  <span class="topic-attempts">${stats.attempts} attempts</span>
                  <span class="topic-best">Best: ${stats.bestScore}%</span>
                </div>
              </div>
            `).join('')}
          </div>
        </div>
        
        <!-- Weak Areas -->
        <div class="progress-card">
          <h3>🎯 Areas for Improvement</h3>
          <div class="weak-areas">
            ${insights.weakestAreas.length > 0 ? 
              insights.weakestAreas.map(area => `
                <div class="weak-area">
                  <div class="weak-concept">${area.concept}</div>
                  <div class="weak-topic">${area.topic}</div>
                  <div class="weak-count">${area.errorCount} errors</div>
                </div>
              `).join('') : 
              '<div class="no-weak-areas">🎉 No weak areas identified yet!</div>'
            }
          </div>
        </div>
        
        <!-- Recent Sessions -->
        <div class="progress-card">
          <h3>🕒 Recent Sessions</h3>
          <div class="session-list">
            ${insights.recentSessions.map(session => `
              <div class="session-item">
                <div class="session-topic">${session.topic}</div>
                <div class="session-score ${session.percentage >= 80 ? 'good' : session.percentage >= 60 ? 'okay' : 'needs-work'}">${session.percentage}%</div>
                <div class="session-date">${session.date}</div>
                <div class="session-time">${Math.round(session.timeSpent / 1000 / 60)}min</div>
              </div>
            `).join('')}
          </div>
        </div>
      </div>
      
      <div class="progress-actions">
        <button onclick="exportProgressData()" class="export-btn">📥 Export Data</button>
        <button onclick="clearProgressData()" class="clear-btn">🗑️ Clear All Data</button>
      </div>
    </div>
  `;
  
  // Show as overlay
  const overlay = document.createElement('div');
  overlay.className = 'progress-overlay';
  overlay.innerHTML = progressHtml;
  document.body.appendChild(overlay);
}

function hideProgressDashboard() {
  const overlay = document.querySelector('.progress-overlay');
  if (overlay) {
    overlay.remove();
  }
}

function exportProgressData() {
  const insights = getProgressInsights();
  const data = {
    exportDate: new Date().toISOString(),
    summary: insights,
    sessions: PROGRESS_DATA.sessions,
    topicStats: PROGRESS_DATA.topicStats
  };
  
  const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `quiz-progress-${new Date().toISOString().split('T')[0]}.json`;
  a.click();
  URL.revokeObjectURL(url);
}

function clearProgressData() {
  if (confirm('Are you sure you want to clear all progress data? This cannot be undone.')) {
    localStorage.removeItem('quiz_progress_data');
    PROGRESS_DATA = {
      sessions: [],
      topicStats: {},
      totalAttempts: 0,
      totalScore: 0,
      bestStreak: 0,
      currentStreak: 0
    };
    hideProgressDashboard();
    alert('Progress data cleared successfully.');
  }
}

// ============ Rendering ============
function setStatus(msg, showLoading = false){ 
  const statusEl = $("status");
  if (showLoading) {
    statusEl.innerHTML = `
      <span>${msg}</span>
      <span class="loading-dots">
        <span class="loading-dot"></span>
        <span class="loading-dot"></span>
        <span class="loading-dot"></span>
      </span>
    `;
  } else {
    statusEl.textContent = msg;
  }
}
function setInfoSetLabel(){
  if (ACTIVE_INDEX<0) {$("setinfo").innerHTML=""; return;}
  $("setinfo").innerHTML = `Active set: <b>Set ${String.fromCharCode(65+ACTIVE_INDEX)}</b> <span class="pill">${QUIZ_SETS[ACTIVE_INDEX].length} questions</span>`;
}
function el(tag, attrs={}, children=[]){
  const e = document.createElement(tag);
  for (const [k,v] of Object.entries(attrs)){
    if (k==='class') e.className=v;
    else if (k==='html') e.innerHTML=v;
    else e.setAttribute(k, v);
  }
  for (const c of children) e.appendChild(c);
  return e;
}

function renderQuiz(){
  const container = $("quiz");
  container.innerHTML = "";
  if (ACTIVE_INDEX<0 || !QUIZ_SETS[ACTIVE_INDEX]){
    container.innerHTML = "<div class='muted'>No quiz loaded. Click <b>Generate quizzes</b> first.</div>";
    return;
  }
  const qs = QUIZ_SETS[ACTIVE_INDEX];
  for (let i=0;i<qs.length;i++){
    const q = qs[i];
    const qBox = el('div', {class:'qbox'});
    const title = el('div', {class:'qtitle', html:`${String(i+1).padStart(2,'0')}. ${q.q.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')}`});
    qBox.appendChild(title);
    
    // Determine input type based on question type
    const inputType = q.multiple ? 'checkbox' : 'radio';
    const inputName = q.multiple ? `q${i}_multi` : `q${i}`;
    
    for (let j=0;j<q.opts.length;j++){
      const id = `q${i}_opt${j}`;
      const label = el('label', {class:'opt', for:id});
      const input = el('input', {type:inputType, name:inputName, id, value:j});
      const text = ` ${['A','B','C','D'][j]}) ${q.opts[j]}`;
      label.appendChild(input);
      label.appendChild(document.createTextNode(text));
      qBox.appendChild(label);
    }
    container.appendChild(qBox);
  }
}

function msToClock(ms){
  const s = Math.floor(ms/1000);
  const mm = Math.floor(s/60).toString().padStart(2,'0');
  const ss = (s%60).toString().padStart(2,'0');
  return mm+':'+ss;
}

function grade(){
  if (ACTIVE_INDEX<0) return;
  const elapsed = Date.now() - START_TIME;
  $("timer").textContent = `Time: ${msToClock(elapsed)}`;

  const qs = QUIZ_SETS[ACTIVE_INDEX];
  let score = 0;
  const rows = [];
  LAST_RESULTS = [];

  for (let i=0;i<qs.length;i++){
    const q = qs[i];
    let isCorrect = false;
    let selLetter = '';
    let selText = '';
    let corrLetter = '';
    let corrText = '';
    
    if (q.multiple) {
      // Handle multiple answer questions
      const selectedBoxes = document.querySelectorAll(`input[name="q${i}_multi"]:checked`);
      const selectedIndices = Array.from(selectedBoxes).map(box => parseInt(box.value));
      const correctIndices = Array.isArray(q.ans) ? q.ans : [q.ans];
      
      // Check if selected answers match correct answers exactly
      selectedIndices.sort();
      correctIndices.sort();
      isCorrect = selectedIndices.length === correctIndices.length && 
                  selectedIndices.every((val, index) => val === correctIndices[index]);
      
      const letters = ['A','B','C','D'];
      selLetter = selectedIndices.length > 0 ? selectedIndices.map(idx => letters[idx]).join(', ') : '—';
      selText = selectedIndices.length > 0 ? selectedIndices.map(idx => q.opts[idx]).join('; ') : 'Not answered';
      corrLetter = correctIndices.map(idx => letters[idx]).join(', ');
      corrText = correctIndices.map(idx => q.opts[idx]).join('; ');
      
    } else {
      // Handle single answer questions
    const selected = document.querySelector(`input[name="q${i}"]:checked`);
    let selIndex = -1;
    if (selected){
      const m = selected.id.match(/_opt(\d)$/);
      if (m) selIndex = parseInt(m[1], 10);
    }
      isCorrect = selIndex === q.ans;
    const letters = ['A','B','C','D'];
      selLetter = selIndex >= 0 ? letters[selIndex] : '—';
      selText = selIndex >= 0 ? q.opts[selIndex] : 'Not answered';
      corrLetter = letters[q.ans];
      corrText = q.opts[q.ans];
    }
    
    if (isCorrect) score += 1;

    LAST_RESULTS.push({
      number: i+1,
      question: q.q,
      selected: selLetter,
      correct: corrLetter,
      correct_text: corrText,
      explanation: q.exp
    });

    rows.push(`
      <div class="feedback-item">
        <div class="feedback-header">
          <span class="question-number">${String(i+1).padStart(2,'0')}.</span>
          <span class="feedback-question">${q.q}</span>
        </div>
        <div class="feedback-answers">
          <span class="your-answer">Your answer: <b>${selLetter}</b> (${selText})</span>
          <span class="correct-answer">Correct: <b>${corrLetter}</b> (${corrText})</span>
          <span class="result-status">${isCorrect ? '<span class="correct">✅ Correct</span>' : '<span class="incorrect">❌ Incorrect</span>'}</span>
        </div>
        <div class="feedback-explanation">
          <strong>Explanation:</strong> ${q.exp}
        </div>
      </div>
    `);
  }

  const pct = Math.round((score/qs.length)*100);
  $("score").innerHTML = `Score: ${score} / ${qs.length} (${pct}%)`;
  
  // Record progress data
  const timeSpent = elapsed;
  const currentTopic = detectTopic(SLIDES_TEXT, 'Current Quiz');
  const questionDetails = LAST_RESULTS.map(result => ({
    question: result.question,
    selectedAnswer: result.selected,
    correctAnswer: result.correct,
    correct: result.selected === result.correct
  }));
  
  const session = recordQuizSession(currentTopic, score, qs.length, timeSpent, questionDetails);
  console.log('Quiz session recorded:', session);
  
  // Create the feedback container with proper structure
  const feedbackHtml = `
    <div class="feedback-container">
      <div class="feedback-header-controls">
        <h4 class="feedback-title">📝 Detailed Results (${qs.length} questions)</h4>
        <div style="display: flex; gap: 10px;">
          <button class="feedback-toggle" onclick="showProgressDashboard()">📊 Progress</button>
          <button class="feedback-toggle" onclick="resetToRandomSet()">🎲 Restart</button>
        </div>
      </div>
      <div class="feedback-content">
        ${rows.join('')}
      </div>
    </div>
  `;
  $("feedback").innerHTML = feedbackHtml;

  const sc = $("scorecard");
  sc.style.display = 'block';
  let tier = 'Keep going';
  if (pct >= 90) tier = 'Excellent';
  else if (pct >= 75) tier = 'Great job';
  else if (pct >= 60) tier = 'Solid start';

  sc.innerHTML = `
    <div class="kpi">
      <div><div class="kpititle">Set</div><div class="kpinum">Set ${String.fromCharCode(65+ACTIVE_INDEX)}</div></div>
      <div><div class="kpititle">Time</div><div class="kpinum">${msToClock(elapsed)}</div></div>
      <div><div class="kpititle">Score</div><div class="kpinum">${pct}%</div></div>
      <div><div class="kpititle">Verdict</div><div class="kpinum">${tier}</div></div>
    </div>`;
  
  // Smooth scroll to the score section instead of bottom
  setTimeout(() => {
    const scoreElement = $("score");
    if (scoreElement) {
      scoreElement.scrollIntoView({behavior: 'smooth', block: 'start'});
    }
  }, 100);
}

function resetToRandomSet(){
  if (!QUIZ_SETS.length){ setStatus("No sets yet. Click Generate quizzes first."); return; }
  const seedStr = $("seed").value.trim();
  if (seedStr){
    RNG = seededRandom(seedStr);
  } else {
    RNG = Math.random;
  }
  ACTIVE_INDEX = randInt(QUIZ_SETS.length);
  setInfoSetLabel();
  START_TIME = Date.now();
  $("timer").textContent = "";
  $("scorecard").style.display = "none";
  $("score").innerHTML = "";
  $("feedback").innerHTML = "";
  renderQuiz();
  window.scrollTo({top: 0, behavior: 'smooth'});
}

// ============ Generate quizzes pipeline ============
async function generateQuizzes(){
  try{
    setStatus("Extracting text", true);
    const files = $("pdfInput").files;
    if (!files || !files.length){ setStatus("Please select at least one PDF."); return; }
    SLIDES_TEXT = await extractTextFromFiles(files);

    // Provide feedback about text extraction
    const textLength = SLIDES_TEXT.trim().length;
    const hasImageContent = SLIDES_TEXT.includes("===== EXTRACTED FROM IMAGES =====");
    console.log(`Extracted ${textLength} characters from ${files.length} PDF(s)`);
    
    // Debug: Show extracted content
    console.log("=== EXTRACTED TEXT PREVIEW ===");
    console.log(SLIDES_TEXT.substring(0, 1000));
    console.log("=== END PREVIEW ===");
    
    if (hasImageContent) {
      setStatus("🎯 Content extracted from images and text - generating comprehensive questions.");
    } else if (textLength < 200) {
      setStatus("⚠️ Limited text extracted - PDFs may contain mostly images. Enhanced fallback active.");
    } else if (textLength < 1000) {
      setStatus("📝 Some text extracted - generating questions with available content.");
    } else {
      setStatus("📚 Good text content found - generating comprehensive questions.");
    }

    const numSets = Math.max(1, Math.min(10, parseInt($("numSets").value || "3", 10)));
    const perSet = Math.max(5, Math.min(60, parseInt($("perSet").value || "30", 10)));
    const useLLM = $("useLLM").checked;
    const apikey = $("apikey").value.trim();
    const seedStr = $("seed").value.trim();
    RNG = seedStr ? seededRandom(seedStr) : Math.random;

    QUIZ_SETS = [];
    if (useLLM && apikey){
      setStatus("Generating with Gemini (may take a moment)", true);
      const slices = sliceForSets(SLIDES_TEXT, numSets);
      for (let i=0;i<numSets;i++){
        setStatus(`Generating set ${i+1} of ${numSets} with Gemini`, true);
        try {
        const qset = await generateSetWithGemini(slices[i], perSet, apikey, 0.7);
        QUIZ_SETS.push(qset);
        } catch (error) {
          console.error(`Error generating set ${i+1} with Gemini:`, error);
          setStatus(`Set ${i+1} failed, using fallback method`, true);
          const qset = heuristicGenerate(SLIDES_TEXT, perSet, RNG);
          QUIZ_SETS.push(qset);
        }
      }
    } else {
      setStatus("Generating questions with enhanced fallback method", true);
      for (let i=0;i<numSets;i++){
        setStatus(`Creating set ${i+1} of ${numSets}`, true);
        const qset = heuristicGenerate(SLIDES_TEXT, perSet, RNG);
        QUIZ_SETS.push(qset);
      }
    }
    setStatus("Done. Loading a random set", true);
    ACTIVE_INDEX = randInt(QUIZ_SETS.length);
    setInfoSetLabel();
    START_TIME = Date.now();
    $("timer").textContent = "";
    renderQuiz();
    
    // Small delay before showing "Ready" to let the UI update
    setTimeout(() => {
    setStatus("Ready.");
    }, 500);
  } catch(e){
    console.error(e);
    setStatus("Error: "+e.message);
  }
}

function sliceForSets(text, k){
  const len = text.length;
  const seg = Math.max(2000, Math.floor(len/k));
  const slices = [];
  for (let i=0; i<k; i++){
    const start = i*seg;
    slices.push(text.substring(start, Math.min(len, start+seg+2000)));
  }
  return slices;
}

// ============ Tutor chat (Gemini) ============
const chatlog = $("chatlog");

function addMsg(text, who='bot'){
  const wrap = document.createElement('div');
  wrap.className = 'msg '+who;
  const bubble = document.createElement('div');
  bubble.className = 'bubble';
  bubble.innerText = text;
  wrap.appendChild(bubble);
  chatlog.appendChild(wrap);
  chatlog.scrollTop = chatlog.scrollHeight;
}

function showTypingIndicator() {
  const wrap = document.createElement('div');
  wrap.className = 'msg bot typing-message';
  wrap.id = 'typing-indicator';
  
  const indicator = document.createElement('div');
  indicator.className = 'typing-indicator';
  
  const dots = document.createElement('div');
  dots.className = 'typing-dots';
  
  for (let i = 0; i < 3; i++) {
    const dot = document.createElement('div');
    dot.className = 'typing-dot';
    dots.appendChild(dot);
  }
  
  indicator.appendChild(dots);
  wrap.appendChild(indicator);
  chatlog.appendChild(wrap);
  chatlog.scrollTop = chatlog.scrollHeight;
}

function hideTypingIndicator() {
  const indicator = document.getElementById('typing-indicator');
  if (indicator) {
    indicator.remove();
  }
}
addMsg("Hi! I'm your AI tutor. Upload slides first, then ask me for hints and explanations based on them. I'll help you understand concepts without giving away quiz answers! 🎓", 'bot');

// ============ API Key Session Management ============
function updateApiStatus() {
  const statusEl = $("api-status");
  const apiKey = $("apikey").value.trim();
  const useLLMCheckbox = $("useLLM");
  
  if (!statusEl) return;
  
  if (apiKey) {
    statusEl.textContent = '✓';
    statusEl.className = 'api-status saved'; 
    // Automatically turn ON Gemini AI when API key is present
    if (useLLMCheckbox && !useLLMCheckbox.checked) {
      useLLMCheckbox.checked = true;
    }
  } else {
    statusEl.textContent = 'Empty';
    statusEl.className = 'api-status empty';
    // Automatically turn OFF Gemini AI when no API key
    if (useLLMCheckbox && useLLMCheckbox.checked) {
      useLLMCheckbox.checked = false;
    }
  }
}

function loadApiKey() {
  const savedKey = sessionStorage.getItem('gemini_api_key');
  const useLLMCheckbox = $("useLLM");
  
  if (savedKey) {
    $("apikey").value = savedKey;
    // Automatically turn ON Gemini AI when saved API key is loaded
    if (useLLMCheckbox) {
      useLLMCheckbox.checked = true;
    }
    updateApiStatus();
    console.log('API key loaded from session storage');
  } else {
    // No saved API key, turn OFF Gemini AI by default
    if (useLLMCheckbox) {
      useLLMCheckbox.checked = false;
    }
    updateApiStatus();
  }
}

function saveApiKey() {
  const apiKey = $("apikey").value.trim();
  if (apiKey) {
    sessionStorage.setItem('gemini_api_key', apiKey);
    console.log('API key saved to session storage');
  } else {
    sessionStorage.removeItem('gemini_api_key');
    console.log('API key removed from session storage');
  }
  updateApiStatus();
}

function clearApiKey() {
  const useLLMCheckbox = $("useLLM");
  
  sessionStorage.removeItem('gemini_api_key');
  $("apikey").value = '';
  
  // Automatically turn OFF Gemini AI when API key is cleared
  if (useLLMCheckbox) {
    useLLMCheckbox.checked = false;
  }
  
  updateApiStatus();
  console.log('API key cleared');
  
  // Show confirmation
  const statusEl = $("api-status");
  if (statusEl) {
    statusEl.textContent = 'Cleared';
    statusEl.className = 'api-status empty';
    setTimeout(() => {
      updateApiStatus();
    }, 2000);
  }
}

// Load API key and progress data on page load
loadApiKey();
loadProgressData();

// Save API key when it changes
$("apikey").addEventListener('input', function() {
  saveApiKey();
});

$("apikey").addEventListener('paste', function() {
  // Small delay to ensure pasted content is processed
  setTimeout(saveApiKey, 100);
});

// Add keyboard support for chat
$("chattext").addEventListener('keypress', function(e) {
  if (e.key === 'Enter') {
    sendMsg();
  }
});

// Add keyboard support for API key field  
$("apikey").addEventListener('keypress', function(e) {
  if (e.key === 'Enter') {
    $("chattext").focus();
  }
});

async function sendMsg(){
  const key = $("apikey").value.trim();
  const txtEl = $("chattext");
  const userText = txtEl.value.trim();
  if (!userText) return;
  
  // Add user message
  addMsg(userText, 'me');
  txtEl.value = "";
  
  if (!key){
    // Show typing indicator briefly for better UX
    showTypingIndicator();
    setTimeout(() => {
      hideTypingIndicator();
    addMsg("Please paste your Gemini API key above to chat.", 'bot');
    }, 800);
    return;
  }
  
  // Show typing indicator
  showTypingIndicator();
  
  const systemHint = `You are a helpful tutor grounded on provided slide text. Give short, clear, step-by-step hints.
Do NOT give direct answers to the quiz; explain concepts or provide similar examples.
Slides context (trimmed):
<slides>${SLIDES_TEXT.substring(0, 20000)}</slides>`;

  const payload = {
    contents: [{ role: "user", parts: [{ text: systemHint + "\n\nQuestion: " + userText }]}]
  };

  try {
    const resp = await fetch("https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key="+encodeURIComponent(key), {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify(payload)
    });
    
    // Hide typing indicator
    hideTypingIndicator();
    
    if (!resp.ok){
      const t = await resp.text();
      addMsg("Error from API: " + t, 'bot');
      return;
    }
    const data = await resp.json();
    const text = (data && data.candidates && data.candidates[0] && data.candidates[0].content && data.candidates[0].content.parts && data.candidates[0].content.parts[0].text) || "No response text.";
    addMsg(text, 'bot');
  } catch (e){
    // Hide typing indicator on error
    hideTypingIndicator();
    addMsg("Network error: " + e.message, 'bot');
  }
}


</script>
</body>
</html>
